
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GnuPG for everything</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    <link rel="stylesheet" href="/styles/icons/iconism.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>GnuPG for everything</h1>
<div>
  <time class="postlist-date" datetime="2023-03-29T17:00:00.000+00:00">Mar 29, 2023</time>
  <ul class="tags">
    
        
          <li><a href="/blog/tags/encryption">#encryption</a></li>
        
    
        
          <li><a href="/blog/tags/gpg">#gpg</a></li>
        
    
        
          <li><a href="/blog/tags/keyserver">#keyserver</a></li>
        
    
        
          <li><a href="/blog/tags/openpgp">#openpgp</a></li>
        
    
        
          <li><a href="/blog/tags/pass">#pass</a></li>
        
    
        
    
        
          <li><a href="/blog/tags/security">#security</a></li>
        
    
        
          <li><a href="/blog/tags/signing">#signing</a></li>
        
    
        
          <li><a href="/blog/tags/ssh">#ssh</a></li>
        
    
        
          <li><a href="/blog/tags/tpm">#tpm</a></li>
        
    
  </ul>
</div>


  <aside>
    <nav class="toc">
                <ol>
                    
                    <li><a href="#setup-keys">1. Setup keys</a>
            
                <ol>
                    
                    <li><a href="#install-gpg">1.1. Install gpg</a>
            		</li>

                    <li><a href="#generate-primary-key">1.2. Generate primary key</a>
            
                <ol>
                    
                    <li><a href="#using-a-config-file">1.2.1. Using a config file</a>
            		</li>

                    <li><a href="#using-quick-generate-key-(recommended)">1.2.2. Using quick-generate-key (recommended)</a>
            		</li>

                    <li><a href="#revocation-key">1.2.3. Revocation key</a>
            		</li>

                    <li><a href="#add-photo">1.2.4. Add photo</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#generate-subkeys">1.3. Generate Subkeys</a>
            		</li>

                    <li><a href="#backup-all-your-keys">1.4. Backup all your keys</a>
            
                <ol>
                    
                    <li><a href="#reset-password-(optional)">1.4.1. Reset password (optional)</a>
            		</li>

                    <li><a href="#backup-to-file">1.4.2. Backup to file</a>
            		</li>

                    <li><a href="#paperkey-backup">1.4.3. Paperkey backup</a>
            
                <ol>
                    
                    <li><a href="#text-paperkey">1.4.3.1. Text paperkey</a>
            		</li>

                    <li><a href="#qr-code-paperkey">1.4.3.2. QR code paperkey</a>
            
                <ol>
                    
                    <li><a href="#generate-qr-code-paperkey">1.4.3.2.1. Generate QR code paperkey</a>
            		</li>

                    <li><a href="#big-private-keys">1.4.3.2.2. Big private keys</a>
            		</li>

                    <li><a href="#re-import-qr-code-paperkey-on-a-different-machine">1.4.3.2.3. Re-import QR code paperkey on a different machine</a>
            		</li>
                </ol>
            		</li>
                </ol>
            		</li>
                </ol>
            		</li>

                    <li><a href="#delete-private-key">1.5. Delete private key</a>
            		</li>

                    <li><a href="#re-import-the-sub-keys-only">1.6. Re-Import the Sub-Keys only</a>
            		</li>

                    <li><a href="#trust-the-key">1.7. Trust the key</a>
            		</li>

                    <li><a href="#optional%3A-publish-key-to-keyserver">1.8. Optional: Publish key to keyserver</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#key-id%3A-short-vs.-long-vs.-keygrip-vs.-fingerprint">2. Key ID: Short vs. Long vs. Keygrip vs. Fingerprint</a>
            		</li>

                    <li><a href="#thoughts-on-multiple-identities">3. Thoughts on multiple identities</a>
            		</li>

                    <li><a href="#thoughts-on-pinentry">4. Thoughts on pinentry</a>
            		</li>

                    <li><a href="#use-tpm-2.0">5. Use TPM 2.0</a>
            
                <ol>
                    
                    <li><a href="#move-subkeys">5.1. Move subkeys</a>
            		</li>

                    <li><a href="#test-signing">5.2. Test signing</a>
            		</li>

                    <li><a href="#troubleshooting-sha-512">5.3. Troubleshooting SHA-512</a>
            		</li>

                    <li><a href="#use-tpm2-from-command-line">5.4. Use tpm2 from command line</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#gpg-agent-log">6. gpg-agent log</a>
            		</li>

                    <li><a href="#ssh-via-gpg">7. SSH via GPG</a>
            		</li>

                    <li><a href="#pass">8. pass</a>
            
                <ol>
                    
                    <li><a href="#passff-for-firefox">8.1. PassFF for Firefox</a>
            		</li>

                    <li><a href="#pass-otp">8.2. pass-otp</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#git%3A-sign-commits-ssh-vs.-gpg">9. git: Sign commits SSH vs. GPG</a>
            		</li>

                    <li><a href="#e-mails">10. E-Mails</a>
            		</li>

                    <li><a href="#chat">11. Chat</a>
            		</li>

                    <li><a href="#links">12. Links</a>
            		</li>
                </ol>
            </nav>
  </aside>


<img src="/blog/2023-03-29-gnupg/gnupg.jpg" width="1280" height="800" alt="undefined">
<p>When I work with Git, I use SSH keys for authentication with GitHub, GitLab etc.
Same goes for SSH connections for terminal connections to servers.</p>
<p>When I want to sign or encrypt my e-mails, I use GPG.
I also use GPG indirectly when using <a href="https://www.passwordstore.org/" class="external-link" target="_blank">pass - The Standard Unix Password Manager</a>.
And you need GPG if you want to publish a package to Maven Central, for example.
You can also use GPG to sign your git commits.</p>
<p>I barely used GPG in the past, but since I heard you can use the GPG key also for SSH connections,
I thought that this would be a big improvement for me.
I would only have to handle the single GPG key instead of having GPG and SSH simultaneously.</p>
<p>I have also used a Nitrokey in <a href="/blog/2021-02-23-nitrokey/">the past</a>, which can be used as a GPG smartcard.
That means your keys wouldn't be stored on your computer, but inaccessible on a secure device. Nice.
Modern computers also have a secure chip built-in, which works similar to a Nitrokey: TPM.</p>
<p>I tried to put this all together to end up with a GPG key stored in the TPM which I can use for:</p>
<ul>
<li>Sign and encrypt files</li>
<li>Sign e-mails</li>
<li>SSH terminal connections</li>
<li>Git authentication (GitHub, GitLab)</li>
<li>Passwords (via pass)</li>
</ul>
<h1 id="setup-keys" tabindex="-1">1. Setup keys <a class="header-anchor" href="#setup-keys" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<h2 id="install-gpg" tabindex="-1">1.1. Install gpg <a class="header-anchor" href="#install-gpg" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>The default <a href="https://archlinux.org/packages/core/x86_64/gnupg/" class="external-link" target="_blank">gpg package</a> in Manjaro/Arch is still 2.2.41, which is the latest LTS version.
However, you need at least 2.3 to work with TPM 2.0. The latest version (as of today) is 2.4.0 released on 2022-12-16.</p>
<figure class="quote">
<blockquote cite="https://bbs.archlinux.org/viewtopic.php?id=269394">
<p>The current stable branch is the 2.2 series, so that's what Arch packages.
The 2.3 series is currently a testing branch for what will become the next stable release, 2.4.
Actually above statement on which version is stable is  incorrect according to Wener Koch of gnupg:
2.3 is in fact the stable branch and latest release is 2.3.4 [1]
2.2 is the older long term stable branch with current version 2.2.34 [2]</p>
</blockquote>
<figcaption class="quote-attribution">https://bbs.archlinux.org/viewtopic.php?id=269394</figcaption>
</figure>
<p>In AUR I couldn't find a 2.4 though. There is a <a href="https://aur.archlinux.org/packages/gnupg-git" class="external-link" target="_blank">gnupg-git</a> which just points to the latest master.
And there is <a href="https://aur.archlinux.org/packages/gnupg23" class="external-link" target="_blank">gnupg23</a>, which is not the latest, but at least an officially released version and the version
just before 2.4.0. I decided to use it.</p>
<p><strong>Edit</strong>: And just as I write this, there was a new package: <a href="https://aur.archlinux.org/packages/gnupg24" class="external-link" target="_blank">gnupg24</a>.
Thank you, ImperatorStorm.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">paru <span class="token parameter variable">-S</span> gnupg24</span></code></pre>

    </div><p>It will warn you that..</p>
<blockquote>
<p>:: gnupg24 and gnupg are in conflict. Remove gnupg? [y/N]</p>
</blockquote>
<p>but you can just proceed with yes.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">gpg <span class="token parameter variable">--version</span></span></span></span>
<span class="highlight-line"><span class="token output">gpg (GnuPG) 2.4.0</span>
<span class="highlight-line">libgcrypt 1.10.1-unknown</span>
<span class="highlight-line">Copyright (C) 2021 Free Software Foundation, Inc.</span>
<span class="highlight-line">License GNU GPL-3.0-or-later &lt;https://gnu.org/licenses/gpl.html></span>
<span class="highlight-line">This is free software: you are free to change and redistribute it.</span>
<span class="highlight-line">There is NO WARRANTY, to the extent permitted by law.</span>
<span class="highlight-line"></span>
<span class="highlight-line">Home: /home/neonew/.gnupg</span>
<span class="highlight-line">Supported algorithms:</span>
<span class="highlight-line">Pubkey: RSA, ELG, DSA, ECDH, ECDSA, EDDSA</span>
<span class="highlight-line">Cipher: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,</span>
<span class="highlight-line">        CAMELLIA128, CAMELLIA192, CAMELLIA256</span>
<span class="highlight-line">Hash: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224</span>
<span class="highlight-line">Compression: Uncompressed, ZIP, ZLIB, BZIP2</span></code></pre>

    </div><h2 id="generate-primary-key" tabindex="-1">1.2. Generate primary key <a class="header-anchor" href="#generate-primary-key" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>We will generate one key for each usage flag of GPG.
Usage flags are: cert, encrypt, sign and auth.</p>
<p>Our primary key will only have the cert flag, and we will have one subkey for each other flag.</p>
<p>You can of course decide you want to do this differently, like having just one primary key with all the flags and no subkeys to have a simpler process.</p>
<h3 id="using-a-config-file" tabindex="-1">1.2.1. Using a config file <a class="header-anchor" href="#using-a-config-file" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>I recommend to use the method below, but for completeness, here is an alternative:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code data-filename="key.config" class="language-plain"><span class="highlight-line">%echo Generating a OpenPGP key</span>
<span class="highlight-line">%echo https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html</span>
<span class="highlight-line">Key-Type: RSA</span>
<span class="highlight-line">Key-Length: 4096</span>
<span class="highlight-line"># Allowed values are ‘encrypt’, ‘sign’, and ‘auth’.</span>
<span class="highlight-line">Key-Usage: cert</span>
<span class="highlight-line">Subkey-Type: RSA</span>
<span class="highlight-line">Subkey-Length: 2048</span>
<span class="highlight-line">Name-Real: My Name</span>
<span class="highlight-line">Name-Comment: MyComment</span>
<span class="highlight-line">Name-Email: my@email.com</span>
<span class="highlight-line">Expire-Date: 0</span>
<span class="highlight-line"># Passphrase: &lt;not used, passed via stdin></span>
<span class="highlight-line"># Do a commit here, so that we can later print "done" :-)</span>
<span class="highlight-line">%commit</span>
<span class="highlight-line">%echo done</span></code></pre>

    </div><div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg <span class="token parameter variable">--batch</span> --generate-key key.config</span></code></pre>

    </div><h3 id="using-quick-generate-key-(recommended)" tabindex="-1">1.2.2. Using quick-generate-key (recommended) <a class="header-anchor" href="#using-quick-generate-key-(recommended)" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>You can also use <code class="language-plain">gpg --gen-key</code> or <code class="language-plain">gpg --full-generate-key</code>, but they require more interactive input, that's
why I like <code class="language-plain">gpg --quick-generate-key</code> best.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --quick-generate-key <span class="token string">"My Name (MyComment) &lt;my@email.com>"</span> rsa4096 cert 1y</span></code></pre>

    </div><h3 id="revocation-key" tabindex="-1">1.2.3. Revocation key <a class="header-anchor" href="#revocation-key" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>You should also generate a revocation key now, in case you forget your password or your key is compromised.
Use the long key id as argument for <code class="language-plain">gen-revoke</code>.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --list-secret-keys --keyid-format long --with-keygrip --with-subkey-fingerprints</span>
<span class="highlight-line">gpg <span class="token parameter variable">--output</span> primary.revoke.asc --gen-revoke 1111111190ABCDEF1234567890ABCDEF11111111</span></code></pre>

    </div><p>Revoke certificate generation is not possible in batch mode. :/</p>
<h3 id="add-photo" tabindex="-1">1.2.4. Add photo <a class="header-anchor" href="#add-photo" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<figure class="quote">
<blockquote cite="https://blog.josefsson.org/2014/06/19/creating-a-small-jpeg-photo-for-your-openpgp-key/">
<p>“Keeping the image close to 240×288 is a good size to use”. Further, there is a warning displayed if the image is above 6144 bytes saying that “This JPEG is really large”.</p>
</blockquote>
<figcaption class="quote-attribution"><a href="https://blog.josefsson.org/2014/06/19/creating-a-small-jpeg-photo-for-your-openpgp-key/" class="external-link" target="_blank">Creating a small JPEG photo for your OpenPGP key</a></figcaption>
</figure>
<p>This is the command I used to generate my small photo, which is just under 6.144 bytes.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">magick convert -auto-orient <span class="token parameter variable">-strip</span> -gaussian-blur <span class="token number">0.05</span> <span class="token parameter variable">-gravity</span> center <span class="token parameter variable">-crop</span> <span class="token number">240</span>:288 +repage <span class="token parameter variable">-resize</span> <span class="token string">"240x288"</span> -sampling-factor <span class="token number">4</span>:2:0 <span class="token parameter variable">-interlace</span> JPEG <span class="token parameter variable">-colorspace</span> YUV <span class="token parameter variable">-quality</span> <span class="token number">52</span> input.jpg gpg.jpg</span></code></pre>

    </div><p>Verify the sampling factor via <code class="language-plain">identify</code>:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">identify <span class="token parameter variable">-format</span> <span class="token string">"%[jpeg:sampling-factor]"</span> gpg.jpg</span></code></pre>

    </div><table>
<thead>
<tr>
<th>Sampling Factor</th>
<th>identity output</th>
</tr>
</thead>
<tbody>
<tr>
<td>4:2:0</td>
<td>2x2,1x1,1x1</td>
</tr>
<tr>
<td>4:2:2H</td>
<td>2x1,1x1,1x1</td>
</tr>
<tr>
<td>4:2:2V</td>
<td>1x2,1x1,1x1</td>
</tr>
<tr>
<td>4:4:4</td>
<td>1x1,1x1,1x1</td>
</tr>
</tbody>
</table>
<p>See here: <a href="https://www.reddit.com/r/GIMP/comments/31w0j2/how_to_find_out_the_chroma_subsampling_of_a_jpg/" class="external-link" target="_blank">How to find out the chroma subsampling of a jpg?</a>.
In my case, the output was just <code class="language-plain">2x2</code>.</p>
<p>If you are happy with the result, add the jpg to your key via:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --edit-key 1111111190ABCDEF1234567890ABCDEF11111111 addphoto save</span></code></pre>

    </div><p>Here is my photo, a 6.109 bytes file:</p>
<img src="/blog/2023-03-29-gnupg/me.jpg" width="240" height="288" alt="undefined">
<h2 id="generate-subkeys" tabindex="-1">1.3. Generate Subkeys <a class="header-anchor" href="#generate-subkeys" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg <span class="token parameter variable">--batch</span> --quick-add-key 1111111190ABCDEF1234567890ABCDEF11111111 rsa2048 sign 1y</span>
<span class="highlight-line">gpg <span class="token parameter variable">--batch</span> --quick-add-key 1111111190ABCDEF1234567890ABCDEF11111111 rsa2048 encrypt 1y</span>
<span class="highlight-line">gpg <span class="token parameter variable">--batch</span> --quick-add-key 1111111190ABCDEF1234567890ABCDEF11111111 rsa2048 auth 1y</span></code></pre>

    </div><h2 id="backup-all-your-keys" tabindex="-1">1.4. Backup all your keys <a class="header-anchor" href="#backup-all-your-keys" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>This is very important. In the following steps, we are going to delete all keys from GPG,
so you need to have a backup of your keys!</p>
<p>Please be aware you should take precautions during this step to make sure your keys don't get stolen.
For example disable network connections, bluetooth etc. and use a strong password.</p>
<h3 id="reset-password-(optional)" tabindex="-1">1.4.1. Reset password (optional) <a class="header-anchor" href="#reset-password-(optional)" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>I case you do not want to use a strong password (for example when you fear you might forget it)
and can make sure nobody gets access to the plain key files, you can reset your password from your key like this:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --change-passphrase 1111111190ABCDEF1234567890ABCDEF11111111</span></code></pre>

    </div><h3 id="backup-to-file" tabindex="-1">1.4.2. Backup to file <a class="header-anchor" href="#backup-to-file" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg <span class="token parameter variable">--output</span> primary-with-subkeys.public.asc <span class="token parameter variable">--armor</span> <span class="token parameter variable">--export</span> 1111111190ABCDEF1234567890ABCDEF11111111</span>
<span class="highlight-line">gpg <span class="token parameter variable">--output</span> primary-with-subkeys.secret.asc <span class="token parameter variable">--armor</span> --export-secret-keys --export-options export-backup 1111111190ABCDEF1234567890ABCDEF11111111</span>
<span class="highlight-line">gpg <span class="token parameter variable">--output</span> subkeys-only.secret.asc <span class="token parameter variable">--armor</span> --export-secret-subkeys --export-options export-backup 1111111190ABCDEF1234567890ABCDEF11111111</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Validate:</span></span>
<span class="highlight-line">gpg --show-keys primary-with-subkeys.public.asc</span>
<span class="highlight-line">gpg --list-packets primary-with-subkeys.public.asc</span>
<span class="highlight-line">pgpdump primary-with-subkeys.public.asc</span></code></pre>

    </div><figure class="quote">
<blockquote cite="https://security.stackexchange.com/questions/51474/one-public-key-contains-all-subkeys">
<p>Subkeys are bound to the primary key and exported together with it when calling gpg --export or gpg --send-keys. Same applies to signatures and user ID packages.</p>
</blockquote>
<figcaption class="quote-attribution"><a href="https://security.stackexchange.com/questions/51474/one-public-key-contains-all-subkeys" class="external-link" target="_blank">One public key contains all subkeys?</a></figcaption>
</figure>
<p>Please note that the exported files will still be password protected by the same password as the original key.</p>
<h3 id="paperkey-backup" tabindex="-1">1.4.3. Paperkey backup <a class="header-anchor" href="#paperkey-backup" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>A paperkey is a method to keep an offline, non-electronic backup of your identity.
You can either print is as text or as a QR code.</p>
<p>Unfortunately there is no widespread way to save your private key as mnemonic to make the whole process easier.
Something like BIP39 for Bitcoin.</p>
<p>Maybe this project <a href="https://github.com/kklash/mnemonikey" class="external-link" target="_blank">mnemonikey</a> is promoising in this regard.
I haven't tried it yet though.</p>
<h4 id="text-paperkey" tabindex="-1">1.4.3.1. Text paperkey <a class="header-anchor" href="#text-paperkey" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h4>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --export-secret-key 1111111190ABCDEF1234567890ABCDEF11111111 <span class="token operator">|</span> paperkey <span class="token operator">></span> paperkey.txt</span></code></pre>

    </div><h4 id="qr-code-paperkey" tabindex="-1">1.4.3.2. QR code paperkey <a class="header-anchor" href="#qr-code-paperkey" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h4>
<h5 id="generate-qr-code-paperkey" tabindex="-1">1.4.3.2.1. Generate QR code paperkey <a class="header-anchor" href="#generate-qr-code-paperkey" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h5>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --export-secret-key 1111111190ABCDEF1234567890ABCDEF11111111 <span class="token operator">|</span> paperkey --output-type raw <span class="token operator">|</span> qrencode <span class="token parameter variable">--8bit</span> <span class="token parameter variable">--output</span> secret-key.qr.png</span></code></pre>

    </div><p>It is possible to increase the error correction level to maximum with the --level H option.
This provides a lost data restoration rate of about 30% at the cost of reduced capacity.
Should the secret key not fit in the QR code, the lower Q and M error correction levels
are also available and give restoration rates of about 25% and 15% respectively.
The default error correction level is L which allows restoration of about 7% of lost data.</p>
<h5 id="big-private-keys" tabindex="-1">1.4.3.2.2. Big private keys <a class="header-anchor" href="#big-private-keys" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h5>
<p>qrencode might fail with <code class="language-plain">Failed to encode the input data: Input data too large</code>.
If the files are too big, you can split them into multiple parts in order to generate multiple QR codes.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --export-secret-key 1111111190ABCDEF1234567890ABCDEF11111111 <span class="token operator">|</span> paperkey --output-type raw <span class="token operator">></span> paper.key</span>
<span class="highlight-line"><span class="token function">split</span> <span class="token parameter variable">-n</span> <span class="token number">2</span> <span class="token parameter variable">-d</span> paper.key paper.key-part-</span>
<span class="highlight-line">qrencode <span class="token parameter variable">--8bit</span> <span class="token parameter variable">--level</span> H --read-from paper.key-part-00 <span class="token parameter variable">--output</span> secret-key.qr.level-h.part-00.png</span>
<span class="highlight-line">qrencode <span class="token parameter variable">--8bit</span> <span class="token parameter variable">--level</span> H --read-from paper.key-part-01 <span class="token parameter variable">--output</span> secret-key.qr.level-h.part-01.png</span></code></pre>

    </div><h5 id="re-import-qr-code-paperkey-on-a-different-machine" tabindex="-1">1.4.3.2.3. Re-import QR code paperkey on a different machine <a class="header-anchor" href="#re-import-qr-code-paperkey-on-a-different-machine" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h5>
<p>Make sure to have the public key available on that machine, as it is not part of the QR code, only the secret parts are.</p>
<p>The public key must be in gpg format (and not an armored asc file).</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">zbarimg <span class="token parameter variable">-1</span> <span class="token parameter variable">--raw</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-Sbinary</span> secret-key.qr.png <span class="token operator">|</span> paperkey <span class="token parameter variable">--pubring</span> paperkey.public.gpg <span class="token operator">|</span> gpg <span class="token parameter variable">--import</span></span></code></pre>

    </div><p>If no or the wrong public key is used, you might see this error message:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">Error: unable to parse OpenPGP packets (is this armored data?)</span>
<span class="highlight-line">Unable to find secret key packet</span></code></pre>

    </div><h2 id="delete-private-key" tabindex="-1">1.5. Delete private key <a class="header-anchor" href="#delete-private-key" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Please, make sure you have a working backup before executing this.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --delete-secret-keys 1111111190ABCDEF1234567890ABCDEF11111111</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Validate:</span></span>
<span class="highlight-line">gpg --list-secret-keys --keyid-format long --with-keygrip --with-subkey-fingerprints</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># To delete a sub-key only, you need the exclamation mark!</span></span>
<span class="highlight-line"><span class="token comment"># gpg --delete-secret-keys 5555ABCDEFAB5555!</span></span></code></pre>

    </div><h2 id="re-import-the-sub-keys-only" tabindex="-1">1.6. Re-Import the Sub-Keys only <a class="header-anchor" href="#re-import-the-sub-keys-only" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>We want to put the primary key backup in a secure place and only leave the sub-keys on our system for everyday use.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg <span class="token parameter variable">--import</span> subkeys-only.secret.asc</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Validate:</span></span>
<span class="highlight-line">gpg --list-secret-keys --keyid-format long --with-keygrip --with-subkey-fingerprints</span></code></pre>

    </div><p>Not the hash sign (#) after the primary key, which indicates it is not stored on the disk.</p>
<h2 id="trust-the-key" tabindex="-1">1.7. Trust the key <a class="header-anchor" href="#trust-the-key" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>In order to sign and encrypt, we need to trust this key.
Just set the trust level to <em>ultimate (5)</em>.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --edit-key 1111111190ABCDEF1234567890ABCDEF11111111 trust quit</span></code></pre>

    </div><h2 id="optional%3A-publish-key-to-keyserver" tabindex="-1">1.8. Optional: Publish key to keyserver <a class="header-anchor" href="#optional%3A-publish-key-to-keyserver" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>If you like, you can share your public key to others by uploading it on a keyserver, like <a href="https://keyserver.ubuntu.com" class="external-link" target="_blank">keyserver.ubuntu.com</a></p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --send-keys 1111111190ABCDEF1234567890ABCDEF11111111</span></code></pre>

    </div><p>See my published key <a href="https://keyserver.ubuntu.com/pks/lookup?search=6FB79D6D075A268571DE9E42C2C14B464D7B72E9&amp;fingerprint=on&amp;op=index" class="external-link" target="_blank">here</a>:</p>
<img src="/blog/2023-03-29-gnupg/keyserver-ubuntu.png" width="1323" height="945" alt="undefined">
<p><a href="/blog/2023-03-29-gnupg/andreas-mausch.public.asc">Download</a></p>
<h1 id="key-id%3A-short-vs.-long-vs.-keygrip-vs.-fingerprint" tabindex="-1">2. Key ID: Short vs. Long vs. Keygrip vs. Fingerprint <a class="header-anchor" href="#key-id%3A-short-vs.-long-vs.-keygrip-vs.-fingerprint" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<table>
<thead>
<tr>
<th>Type</th>
<th style="text-align:right">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fingerprint</td>
<td style="text-align:right">7196 E081 94D5 3FCB FD15  D960 FA6C 71F9 A73D BE0B</td>
</tr>
<tr>
<td>Long Key ID</td>
<td style="text-align:right">FA6C 71F9 A73D BE0B</td>
</tr>
<tr>
<td>Short Key ID</td>
<td style="text-align:right">A73D BE0B</td>
</tr>
<tr>
<td>Keygrip</td>
<td style="text-align:right">69B7 D1FB F6F4 8ACA 5453  1CB7 7108 8109 C081 C081</td>
</tr>
</tbody>
</table>
<figure class="quote">
<blockquote cite="https://unix.stackexchange.com/questions/576933/what-are-the-keyid-and-finguerprint-of-a-public-key-in-gpg-and-apt-key]">
<p>Neither of these [long and short ID] should be used for key identification nowadays — it is possible to create keys with matching key ids (and this has been demonstrated with short key ids).</p>
</blockquote>
<figcaption class="quote-attribution"><a href="https://unix.stackexchange.com/questions/576933/what-are-the-keyid-and-finguerprint-of-a-public-key-in-gpg-and-apt-key" class="external-link" target="_blank">https://unix.stackexchange.com/questions/576933/what-are-the-keyid-and-finguerprint-of-a-public-key-in-gpg-and-apt-key</a></figcaption>
</figure>
<p>-&gt; <strong>Always use the fingerprint for the Key ID</strong></p>
<p>What is the Keygrip then?</p>
<figure class="quote">
<blockquote cite="https://blog.djoproject.net/2020/05/03/main-differences-between-a-gnupg-fingerprint-a-ssh-fingerprint-and-a-keygrip/]">
<p>So a keygrip is protocol agnostic, that means no information coming from GnuPG (e.g. the packet version) nor SSH (e.g. the typename) is used to build them. Only information coming from the key algorithm is used.</p>
</blockquote>
<figcaption class="quote-attribution"><a href="https://blog.djoproject.net/2020/05/03/main-differences-between-a-gnupg-fingerprint-a-ssh-fingerprint-and-a-keygrip/" class="external-link" target="_blank">https://blog.djoproject.net/2020/05/03/main-differences-between-a-gnupg-fingerprint-a-ssh-fingerprint-and-a-keygrip/</a></figcaption>
</figure>
<p>Also, the keygrip has the same length as a fingerprint:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">7196E08194D53FCBFD15D960FA6C71F9A73DBE0B</span>
<span class="highlight-line">69B7D1FBF6F48ACA54531CB771088109C081C081</span></code></pre>

    </div><p>Pff...confuse me more.
gpg cli in my opinion should never display the short and long key ids if they are not to be trusted.
<code class="language-plain">--with-subkey-fingerprints</code> should be the default.
And gpg should put a prefix/name if it outputs a (seemingly) random number to the user. But well.</p>
<h1 id="thoughts-on-multiple-identities" tabindex="-1">3. Thoughts on multiple identities <a class="header-anchor" href="#thoughts-on-multiple-identities" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I would love to only use a single identity for all purposes, because I am a single person.</p>
<p>However, I do use a separate GPG key for personal and business usages.
I might even split up my personal keys further, depending on how secret something should really be.</p>
<p>The reason is (as someone on the internet pointed out): You need to expose your whole social network with GPG.
You need to connect all your personal and business e-mail addresses to your UIDs, if you decide to use a single key.
You cannot keep like a single e-mail-address private or disconnect it. It would need to be a UID in a different key then.</p>
<p>It is by design.</p>
<p>I would like to see a combined key which expresses &quot;I am Andreas and I am using my personal laptop&quot;, which is pretty much
the same as <em>please confirm your new device</em> messages from various services.
My identity would still be <em>Andreas</em>, but I'd need a second secret to get access to some service.
I'm not sure whether this is possible with GPG.</p>
<h1 id="thoughts-on-pinentry" tabindex="-1">4. Thoughts on pinentry <a class="header-anchor" href="#thoughts-on-pinentry" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I dislike you cannot see which process asked for the key when doing a decryption or signing.
pinentry just pops ups and asks for a your passphrase.</p>
<p>The user cannot see which process (maybe with PID and icon) wants to use the key for what reason.</p>
<h1 id="use-tpm-2.0" tabindex="-1">5. Use TPM 2.0 <a class="header-anchor" href="#use-tpm-2.0" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>See <a href="https://gnupg.org/blog/20210315-using-tpm-with-gnupg-2.3.html" class="external-link" target="_blank">this guide</a> from the official gnupg.org page.</p>
<p>Important: TPM only supports a specific set of algorithms for encryption and hashing.
Make sure you use algorithms supported by your hardware.</p>
<p>TPM 2.0 gurantees RSA-2048 and SHA-256 will work.</p>
<p>Make sure to add yourself to the <em>tss</em> group:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">sudo</span> pacman <span class="token parameter variable">-S</span> tpm2-tools</span>
<span class="highlight-line"><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> tss <span class="token environment constant">$USER</span></span></code></pre>

    </div><p>One thing I'd like to see is TPM with a smartcard interface.
I can't understand why there need to be <code class="language-plain">keytocard</code> and <code class="language-plain">keytotpm</code> commands, when they are essentially doing the same thing.
I do understand TPM is different from a smartcard and maybe offers more features, but it just would be nice to support the smartcard interface.
On Windows for example, there is a thing like a <a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/virtual-smart-cards/virtual-smart-card-overview" class="external-link" target="_blank">TPM virtual smart card</a>.
That's what I mean, but it should be part of TPM, in my opinion.</p>
<p>Regarding the trustworthiness of TPM: I can't really tell, and there might be backdoors.
I just like the concept that the private key is never accessible in the RAM of the computer.
That's the main reason I prefer it over password-protected keys (without TPM), even though the latter might be more trustworthy.</p>
<h2 id="move-subkeys" tabindex="-1">5.1. Move subkeys <a class="header-anchor" href="#move-subkeys" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">gpg --edit-key 1111111190ABCDEF1234567890ABCDEF11111111 <span class="token string">"key 5555ABCDEFAB5555"</span> keytotpm quit</span>
<span class="highlight-line">gpg --edit-key 1111111190ABCDEF1234567890ABCDEF11111111 <span class="token string">"key 6666ABCDEFAB6666"</span> keytotpm quit</span>
<span class="highlight-line">gpg --edit-key 1111111190ABCDEF1234567890ABCDEF11111111 <span class="token string">"key 7777725CD5447777"</span> keytotpm quit</span></code></pre>

    </div><p>You need to enter the original password of your gpg key and then you can choose the same (or different) password used by the TPM.
Note the <code class="language-plain">></code> signs after ssb in the <code class="language-plain">gpg --list-secret-keys</code> output, which tells the key is now stored inside the TPM and cannot be accessed directly anymore.</p>
<h2 id="test-signing" tabindex="-1">5.2. Test signing <a class="header-anchor" href="#test-signing" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Make sure the subkey still works:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token builtin class-name">echo</span> Test <span class="token operator">></span> test.txt</span>
<span class="highlight-line">gpg --clear-sign --local-user my@email.com <span class="token parameter variable">--output</span> test.txt.asc test.txt</span>
<span class="highlight-line"><span class="token function">cat</span> test.txt.asc</span>
<span class="highlight-line"><span class="token function">rm</span> test.txt test.txt.asc</span></code></pre>

    </div><p>You are now asked to enter the TPM password.</p>
<h2 id="troubleshooting-sha-512" tabindex="-1">5.3. Troubleshooting SHA-512 <a class="header-anchor" href="#troubleshooting-sha-512" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>I had a problem connecting to my server via SSH after I moved the keys to the TPM.</p>
<p>It took me some time to find the reason: SSH tried to do the signature with SHA-512, which is not supported by my TPM.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-vvvv</span> nuc@nuc</span></span></span>
<span class="highlight-line"><span class="token output">debug1: Server accepts key: (none) RSA SHA256:++3tZOdzV9LhXrOHIkn8Cvfm4OknxQ8UYT7vjg7PQDw agent</span>
<span class="highlight-line">debug3: sign_and_send_pubkey: using publickey with RSA SHA256:++3tZOdzV9LhXrOHIkn8Cvfm4OknxQ8UYT7vjg7PQDw</span>
<span class="highlight-line">debug3: sign_and_send_pubkey: signing using rsa-sha2-512 SHA256:++3tZOdzV9LhXrOHIkn8Cvfm4OknxQ8UYT7vjg7PQDw</span>
<span class="highlight-line">sign_and_send_pubkey: signing failed for RSA "(none)" from agent: agent refused operation</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">systemctl <span class="token parameter variable">--user</span> status gpg-agent</span></span></span>
<span class="highlight-line"><span class="token output">● gpg-agent.service - GnuPG cryptographic agent and passphrase cache</span>
<span class="highlight-line">     Loaded: loaded (/usr/lib/systemd/user/gpg-agent.service; static)</span>
<span class="highlight-line">     Active: active (running) since Tue 2023-03-28 23:39:17 CEST; 33min ago</span>
<span class="highlight-line">TriggeredBy: ● gpg-agent-extra.socket</span>
<span class="highlight-line">             ● gpg-agent-ssh.socket</span>
<span class="highlight-line">             ● gpg-agent-browser.socket</span>
<span class="highlight-line">             ● gpg-agent.socket</span>
<span class="highlight-line">       Docs: man:gpg-agent(1)</span>
<span class="highlight-line">   Main PID: 1316 (gpg-agent)</span>
<span class="highlight-line">      Tasks: 8 (limit: 38083)</span>
<span class="highlight-line">     Memory: 16.6M</span>
<span class="highlight-line">        CPU: 6.257s</span>
<span class="highlight-line">     CGroup: /user.slice/user-1000.slice/user@1000.service/app.slice/gpg-agent.service</span>
<span class="highlight-line">             ├─1316 /usr/bin/gpg-agent --supervised</span>
<span class="highlight-line">             ├─3031 scdaemon --multi-server</span>
<span class="highlight-line">             └─3034 tpm2daemon --multi-server</span>
<span class="highlight-line"></span>
<span class="highlight-line">Mär 29 00:12:57 andreas-peac gpg-agent[3034]: ERROR:esys:src/tss2-esys/esys_iutil.c:394:iesys_handle_to_tpm_handle() Error: Esys invalid ESAPI handle (ff).</span>
<span class="highlight-line">Mär 29 00:12:57 andreas-peac gpg-agent[3034]: ERROR:esys:src/tss2-esys/esys_iutil.c:1105:esys_GetResourceObject() Unknown ESYS handle. ErrorCode (0x0007000b)</span>
<span class="highlight-line">Mär 29 00:12:57 andreas-peac gpg-agent[3034]: ERROR:esys:src/tss2-esys/esys_tr.c:522:Esys_TRSess_SetAttributes() Object not found ErrorCode (0x0007000b)</span>
<span class="highlight-line">Mär 29 00:12:57 andreas-peac gpg-agent[3034]: tpm2daemon[3034]: DBG: asking for PIN 'TPM Key Passphrase'</span>
<span class="highlight-line">Mär 29 00:12:58 andreas-peac gpg-agent[3034]: WARNING:esys:src/tss2-esys/api/Esys_Sign.c:311:Esys_Sign_Finish() Received TPM Error</span>
<span class="highlight-line">Mär 29 00:12:58 andreas-peac gpg-agent[3034]: ERROR:esys:src/tss2-esys/api/Esys_Sign.c:105:Esys_Sign() Esys Finish ErrorCode (0x000001d5)</span>
<span class="highlight-line">Mär 29 00:12:58 andreas-peac gpg-agent[3034]: TPM2_Sign failed with 469</span>
<span class="highlight-line">Mär 29 00:12:58 andreas-peac gpg-agent[3034]: tpm:parameter(1):structure is the wrong size</span>
<span class="highlight-line">Mär 29 00:12:58 andreas-peac gpg-agent[1316]: smartcard signing failed: Kartenfehler</span>
<span class="highlight-line">Mär 29 00:12:58 andreas-peac gpg-agent[1316]: ssh sign request failed: Kartenfehler &lt;Quelle nicht angegeben></span></code></pre>

    </div><p>The important bits here are <code class="language-plain">TPM2_Sign failed with 469</code> and <code class="language-plain">structure is the wrong size</code>.
See here: <a href="https://lists.archive.carbon60.com/gnupg/devel/91138" class="external-link" target="_blank">lists.archive.carbon60.com/gnupg/devel/91138</a></p>
<p>Depending on the sshd_config, you might need to specify the algorithm.
SHA-512 is not compatible with TPM2.0, so you might try this:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">ssh</span> <span class="token parameter variable">-vvvv</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">PubkeyAcceptedKeyTypes</span><span class="token operator">=</span>rsa-sha2-256 nuc@nuc</span></code></pre>

    </div><p>Or, alternatively you can set this option for all connections (you might need to append the file):</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code data-filename="~/.ssh/config" class="language-plain"><span class="highlight-line">Host *</span>
<span class="highlight-line">  PubkeyAcceptedKeyTypes rsa-sha2-256</span></code></pre>

    </div><h2 id="use-tpm2-from-command-line" tabindex="-1">5.4. Use tpm2 from command line <a class="header-anchor" href="#use-tpm2-from-command-line" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Test supported algorithms:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token comment"># List supported algorithms:</span></span>
<span class="highlight-line">tpm2_getcap algorithms</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Test specific algorithm</span></span>
<span class="highlight-line">tpm2_testparms rsa2048</span>
<span class="highlight-line">tpm2_testparms rsa4096</span></code></pre>

    </div><p>To use TPM without GPG you can run <a href="https://github.com/salrashid123/tpm2/tree/master/tpm_import_external_rsa" class="external-link" target="_blank">this example</a>.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">openssl genrsa <span class="token parameter variable">-out</span> private.pem <span class="token number">2048</span></span>
<span class="highlight-line">openssl rsa <span class="token parameter variable">-in</span> private.pem <span class="token parameter variable">-outform</span> PEM <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> public.pem</span>
<span class="highlight-line">tpm2_createprimary <span class="token parameter variable">--hierarchy</span><span class="token operator">=</span>e --key-algorithm<span class="token operator">=</span>rsa2048 --key-context<span class="token operator">=</span>primary.ctx</span>
<span class="highlight-line">tpm2_import <span class="token parameter variable">-C</span> primary.ctx <span class="token parameter variable">-G</span> rsa <span class="token parameter variable">-i</span> private.pem <span class="token parameter variable">-u</span> key.pub <span class="token parameter variable">-r</span> key.priv <span class="token comment"># e stands for TPM_RH_ENDORSEMENT</span></span>
<span class="highlight-line"><span class="token function">rm</span> private.pem</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token builtin class-name">echo</span> <span class="token string">"This is the secret"</span> <span class="token operator">></span> test.txt</span>
<span class="highlight-line">openssl pkeyutl <span class="token parameter variable">-encrypt</span> <span class="token parameter variable">-pubin</span> <span class="token parameter variable">-inkey</span> public.pem <span class="token parameter variable">-in</span> test.txt <span class="token parameter variable">-out</span> test.txt.enc</span>
<span class="highlight-line"></span>
<span class="highlight-line">tpm2_load <span class="token parameter variable">-C</span> primary.ctx <span class="token parameter variable">-u</span> key.pub <span class="token parameter variable">-r</span> key.priv <span class="token parameter variable">-c</span> key.ctx</span>
<span class="highlight-line">tpm2_rsadecrypt <span class="token parameter variable">-c</span> key.ctx <span class="token parameter variable">-o</span> test.decrypted.txt test.txt.enc</span>
<span class="highlight-line"><span class="token function">cat</span> test.decrypted.txt</span>
<span class="highlight-line"><span class="token function">rm</span> test.txt test.txt.enc test.decrypted.txt public.pem primary.ctx key.pub key.priv</span></code></pre>

    </div><p>My TPM2 does not support RSA with 4096-bits keys.
I get the same error as described <a href="https://github.com/tpm2-software/tpm2-tools/issues/1909" class="external-link" target="_blank">here</a>.</p>
<p>Which is a pity, because tools like forgejo <a href="https://codeberg.org/Codeberg/Community/issues/1576" class="external-link" target="_blank">require at least 3072 bits</a>.</p>
<figure class="quote">
<blockquote cite="https://github.com/go-gitea/gitea/pull/26604]">
<p>German Federal Office for Information Security requests in its technical guideline BSI TR-02102-1 RSA Keylength not shorter than 3000bits starting 2024, in the year 2023 3000bits as a recommendation.</p>
</blockquote>
<figcaption class="quote-attribution"><a href="https://github.com/go-gitea/gitea/pull/26604" class="external-link" target="_blank">https://github.com/go-gitea/gitea/pull/26604</a></figcaption>
</figure>
<h1 id="gpg-agent-log" tabindex="-1">6. gpg-agent log <a class="header-anchor" href="#gpg-agent-log" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">systemctl <span class="token parameter variable">--user</span> status gpg-agent</span></code></pre>

    </div><h1 id="ssh-via-gpg" tabindex="-1">7. SSH via GPG <a class="header-anchor" href="#ssh-via-gpg" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>GPG Key with usage flag <em>Authentication</em> is needed.</p>
<p>Here is my setup for <code class="language-plain">gpg-agent</code> and the <code class="language-plain">fish</code> shell.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token builtin class-name">echo</span> enable-ssh-support <span class="token operator">>></span> ~/.gnupg/gpg-agent.conf</span>
<span class="highlight-line"><span class="token builtin class-name">echo</span> <span class="token operator">&lt;</span>SSH-SUBKEY-KEYGRIP<span class="token operator">></span> <span class="token operator">>></span> ~/.gnupg/sshcontrol</span>
<span class="highlight-line">gpg --export-ssh-key 1111111190ABCDEF1234567890ABCDEF11111111</span></code></pre>

    </div><div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code data-filename="~/.config/fish/conf.d/gpg-ssh.fish" class="language-plain"><span class="highlight-line">set --erase SSH_AGENT_PID</span>
<span class="highlight-line">set --erase SSH_AUTH_SOCK</span>
<span class="highlight-line">set --universal --export SSH_AUTH_SOCK (gpgconf --list-dirs agent-ssh-socket)</span>
<span class="highlight-line">set --export GPG_TTY (tty)</span>
<span class="highlight-line">gpg-connect-agent updatestartuptty /bye >/dev/null</span></code></pre>

    </div><h1 id="pass" tabindex="-1">8. pass <a class="header-anchor" href="#pass" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>pass automatically works with GPG, so all you need to do is set up the right key:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">pass init <span class="token punctuation">[</span>-p subfolder<span class="token punctuation">]</span> 1111111190ABCDEF1234567890ABCDEF11111111</span></code></pre>

    </div><h2 id="passff-for-firefox" tabindex="-1">8.1. PassFF for Firefox <a class="header-anchor" href="#passff-for-firefox" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>To automatically fill passwords in your browser, use this sweet extension:
<a href="https://github.com/passff/passff" class="external-link" target="_blank">github.com/passff/passff</a></p>
<p>Unfortunately, it requires a host service to run on your machine.
It works well, though.</p>
<p>I prefer it over <a href="https://github.com/browserpass/browserpass-extension" class="external-link" target="_blank">github.com/browserpass/browserpass-extension</a>,
because it doesn't require your filename to match the URL of a service.
I prefer to have a paypal.gpg rather than a paypal.com.gpg.</p>
<p>Reason: I have an account for a service, not a domain.
Domains might change, and to support multiple domains, you
<a href="https://github.com/browserpass/browserpass-extension#how-to-use-the-same-username-and-password-pair-on-multiple-domains" class="external-link" target="_blank">need hacks</a>.</p>
<p>This specific problem is <a href="https://github.com/passff/passff/issues/466" class="external-link" target="_blank">not solved</a> for passff either,
but I like the approach to specify the URL inside the data just better.</p>
<p>Make sure to enable the configuration option <code class="language-plain">Index URL fields on startup</code>.</p>
<p>Installation and example usage of passff:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">sudo</span> pacman <span class="token parameter variable">-S</span> passff-host firefox-extension-passff</span></code></pre>

    </div><div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">pass insert <span class="token parameter variable">-m</span> someservice</span></span></span>
<span class="highlight-line"><span class="token output">Enter contents of someservice and press Ctrl+D when finished:</span>
<span class="highlight-line"></span>
<span class="highlight-line">my-secret-password</span>
<span class="highlight-line">login: my@email.com</span>
<span class="highlight-line">url: someservice.com</span>
<span class="highlight-line">[master 6e0d7a4] Add given password for someservice to store.</span>
<span class="highlight-line"> 1 file changed, 2 insertions(+)</span>
<span class="highlight-line"> create mode 100644 someservice.gpg</span></code></pre>

    </div><h2 id="pass-otp" tabindex="-1">8.2. pass-otp <a class="header-anchor" href="#pass-otp" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>There is also the neat <a href="https://archlinux.org/packages/community/any/pass-otp/" class="external-link" target="_blank">pass-otp</a> extension for pass, which can generate your 2FA numbers.
However, I prefer to keep a real second factor with my Android phone and <a href="https://github.com/beemdevelopment/Aegis" class="external-link" target="_blank">Aegis</a>.
I dislike the idea of having all secrets on the same device for a reason.</p>
<h1 id="git%3A-sign-commits-ssh-vs.-gpg" tabindex="-1">9. git: Sign commits SSH vs. GPG <a class="header-anchor" href="#git%3A-sign-commits-ssh-vs.-gpg" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Since 2021 it is also possible to use SSH (and not just GPG) to sign commits.</p>
<p>I like GPG better though: It can contain your uid (or multiple), a photo, sharing via keyservers is easier..</p>
<p>Also, I'm not sure if common other tools like Thunderbird support signing via SSH key, so I want to have a GPG key anyway.</p>
<h1 id="e-mails" tabindex="-1">10. E-Mails <a class="header-anchor" href="#e-mails" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I'd love to use OpenPGP signing with Thunderbird.
I don't really care about encryption here, but signing would be nice.</p>
<p>However, I wasn't able to connect Thunderbird to my GPG-managed TPM key.</p>
<p>Previous to Thunderbird 78 there was a plugin named Enigmail, which worked great in combination with GnuPG.
Since then, Thunderbird decided to not use GnuPG any longer &quot;to avoid licensing issues&quot; <a href="https://support.mozilla.org/en-US/kb/openpgp-thunderbird-howto-and-faq#w_does-openpgp-in-thunderbird-78-look-and-work-exactly-like-enigmail" class="external-link" target="_blank">source</a>.</p>
<p>They chose to integrate OpenPGP directly into the program (so no additional plugin needed -&gt; yay),
but their library RNP does not support SmartCards at all, and also no TPM (boo!).
To me it is not understandable how you strip an important feature like that from a working extension
without replacement.</p>
<p>Sooo....Thunderbird added a hidden feature <em>allow_external_gnupg</em> which uses the GPGME library to access the GnuPG keys.
See their <a href="https://wiki.mozilla.org/Thunderbird:OpenPGP:Smartcards" class="external-link" target="_blank">guide here</a>.</p>
<p>I tried to use it and failed, and in general it seemed not user-friendly to me yet.
Duplicating the public keys in another keychain is bad enough, you can only configure one Key-ID, there is no check the Key-ID you enter is valid
and the error message I got when signing a message was only visible in the Error Console.</p>
<p>It complained that <code class="language-plain">GPGME.allDependenciesLoaded()</code> returned false, however I had the <code class="language-plain">gpgme</code> package installed on my machine.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">ls</span> <span class="token parameter variable">-lah</span> /usr/lib/libgpgme.so</span></span></span>
<span class="highlight-line"><span class="token output">lrwxrwxrwx 1 root root 19 20. Mär 14:58 /usr/lib/libgpgme.so -> libgpgme.so.11.28.0*</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">gpgme-tool</span></span></span>
<span class="highlight-line"><span class="token output">OK GPGME-Tool 1.19.0 ready</span>
<span class="highlight-line">KEYLIST</span>
<span class="highlight-line">D &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?>%0A</span>
<span class="highlight-line">D &lt;gpgme>%0A</span>
<span class="highlight-line">D   &lt;keylist>%0A</span>
<span class="highlight-line">D     &lt;key>%0A</span>
<span class="highlight-line">D       &lt;revoked value="0x0" />%0A</span>
<span class="highlight-line">D       &lt;expired value="0x0" />%0A</span></code></pre>

    </div><p>Maybe in an incompatible version, because I have updated gpg manually..? I don't know, and I didn't investigate further.</p>
<p>Update: After restarting my system and re-configuring the GPG key in Thunderbird I got it working.
I needed to use the Long Key ID.
I use multiple e-mail addresses, so I had to make sure to configure the right one (via <em>Manage identities...</em>):</p>
<img src="/blog/2023-03-29-gnupg/thunderbird-settings.png" width="1547" height="1077" alt="undefined">
<h1 id="chat" tabindex="-1">11. Chat <a class="header-anchor" href="#chat" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>XMPP supports an experimental <a href="https://xmpp.org/extensions/xep-0373.html" class="external-link" target="_blank">extension</a> for OpenPGP support.</p>
<p>I've tried to use it with the Gajim client, which did not work well.</p>
<p>The <a href="https://dev.gajim.org/gajim/gajim-plugins/-/tree/master/openpgp" class="external-link" target="_blank">OpenPGP plugin</a>
for Gajim tries to create a new key and fails.
I wasn't able to re-use my existing key.</p>
<img src="/blog/2023-03-29-gnupg/gajim-openpgp-wizard-error.png" width="1497" height="878" alt="undefined">
<p>I did install <code class="language-plain">sudo pacman -S python-gpgme</code> beforehand and I was able to call gpgme in the python interpreter successfully
(<code class="language-plain">gpg.Context().create_key('myname')</code>), so I don't know what went wrong here.</p>
<h1 id="links" tabindex="-1">12. Links <a class="header-anchor" href="#links" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<ul>
<li><a href="https://wxcafe.net/posts/yubikey_for_everything/" class="external-link" target="_blank">https://wxcafe.net/posts/yubikey_for_everything/</a> (Post title was inspired by this)</li>
<li><a href="https://mikeross.xyz/create-gpg-key-pair-with-subkeys/" class="external-link" target="_blank">https://mikeross.xyz/create-gpg-key-pair-with-subkeys/</a></li>
<li><a href="https://wiki.archlinux.org/title/GnuPG#SSH_agent" class="external-link" target="_blank">https://wiki.archlinux.org/title/GnuPG#SSH_agent</a></li>
<li><a href="https://gist.github.com/mcattarinussi/834fc4b641ff4572018d0c665e5a94d3" class="external-link" target="_blank">https://gist.github.com/mcattarinussi/834fc4b641ff4572018d0c665e5a94d3</a></li>
<li><a href="https://opensource.com/article/19/4/gpg-subkeys-ssh" class="external-link" target="_blank">https://opensource.com/article/19/4/gpg-subkeys-ssh</a></li>
<li><a href="https://www.foxk.it/blog/gpg-ssh-agent-fish/" class="external-link" target="_blank">https://www.foxk.it/blog/gpg-ssh-agent-fish/</a></li>
</ul>


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
