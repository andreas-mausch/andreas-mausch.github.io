
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitMQ: Message persistence and Metrics</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    <link rel="stylesheet" href="/styles/icons/iconism.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>RabbitMQ: Message persistence and Metrics</h1>
<div>
  <time class="postlist-date" datetime="2021-05-17T17:00:00.000+00:00">May 17, 2021</time>
  <ul class="tags">
    
        
          <li><a href="/blog/tags/cli">#cli</a></li>
        
    
        
          <li><a href="/blog/tags/devops">#devops</a></li>
        
    
        
          <li><a href="/blog/tags/message-queue">#message-queue</a></li>
        
    
        
          <li><a href="/blog/tags/metrics">#metrics</a></li>
        
    
        
    
        
          <li><a href="/blog/tags/rabbitmq">#rabbitmq</a></li>
        
    
  </ul>
</div>



<h1 id="persistence" tabindex="-1">1. Persistence <a class="header-anchor" href="#persistence" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>We've noticed our RabbitMQ lost messages when the container had to be restarted.</p>
<p>Three things to consider to not lose stuff on a restart:</p>
<ul>
<li>Your exchanges and queues should be <strong>durable</strong></li>
<li>Your messages should be <strong>persistent</strong></li>
<li>If you run RabbitMQ via Docker, make sure to set a fixed hostname</li>
</ul>
<p>Links to RabbitMQ's documentation:</p>
<ul>
<li><a href="https://www.rabbitmq.com/queues.html#durability" class="external-link" target="_blank">Queue durability</a></li>
<li><a href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html" class="external-link" target="_blank">Message durability</a> (scroll down to <em>Message durability</em>)</li>
<li><a href="https://www.rabbitmq.com/persistence-conf.html" class="external-link" target="_blank">Persistence Configuration</a></li>
</ul>
<p>I will show you how I enabled queue and message durability in a Java project based on Micronaut.</p>
<img src="/blog/2021-05-14-rabbitmq-persistence/rabbitmq-persistence.png" width="2390" height="1356" alt="undefined">
<h2 id="queue-and-exchange-durability" tabindex="-1">1.1. Queue and Exchange durability <a class="header-anchor" href="#queue-and-exchange-durability" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<h3 id="java-client" tabindex="-1">1.1.1. Java Client <a class="header-anchor" href="#java-client" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>The RabbitMQ Java client's method <code class="language-plain">com.rabbitmq.client.Channel#queueDeclare</code> takes a boolean parameter <code class="language-plain">durable</code>.
Set it to true when you declare your queue, and you're done.
The queue will now survive a restart.</p>
<p>Same for exchanges in the method <code class="language-plain">com.rabbitmq.client.Channel#exchangeDeclare</code>.</p>
<h3 id="micronaut" tabindex="-1">1.1.2. Micronaut <a class="header-anchor" href="#micronaut" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>You will most likely have an implementation of <code class="language-plain">ChannelInitializer</code>, as shown in their
<a href="https://micronaut-projects.github.io/micronaut-rabbitmq/latest/guide/#initialization" class="external-link" target="_blank">documentation</a>.</p>
<p>There, you will find the declaration calls.</p>
<h3 id="cli" tabindex="-1">1.1.3. CLI <a class="header-anchor" href="#cli" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">rabbitmqadmin <span class="token builtin class-name">declare</span> exchange <span class="token assign-left variable">name</span><span class="token operator">=</span>my-new-exchange <span class="token assign-left variable">type</span><span class="token operator">=</span>fanout <span class="token assign-left variable">durable</span><span class="token operator">=</span>true</span>
<span class="highlight-line">rabbitmqadmin <span class="token builtin class-name">declare</span> queue <span class="token assign-left variable">name</span><span class="token operator">=</span>my-new-queue <span class="token assign-left variable">durable</span><span class="token operator">=</span>true</span></code></pre>

    </div><h2 id="message-durability" tabindex="-1">1.2. Message durability <a class="header-anchor" href="#message-durability" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<h3 id="java-client-1" tabindex="-1">1.2.1. Java Client <a class="header-anchor" href="#java-client-1" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>Now for the message durability, the method <code class="language-plain">com.rabbitmq.client.Channel#basicPublish</code> takes a parameter <code class="language-plain">props</code> of the type
<code class="language-plain">BasicProperties</code>. In there, you need to set <code class="language-plain">deliveryMode</code> to the magic hard-coded value <code class="language-plain">2</code>. Well.</p>
<h3 id="micronaut-1" tabindex="-1">1.2.2. Micronaut <a class="header-anchor" href="#micronaut-1" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>For a Micronaut producer, find the class annotated with <code class="language-plain">@RabbitClient</code>.
There, you can set another annotation <code class="language-plain">@RabbitProperty</code> as follows:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-java"><code class="language-java"><span class="highlight-line"><span class="token annotation punctuation">@RabbitClient</span><span class="token punctuation">(</span><span class="token string">"exchange-name"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token annotation punctuation">@RabbitProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"deliveryMode"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"2"</span><span class="token punctuation">)</span></span></code></pre>

    </div><h3 id="cli-1" tabindex="-1">1.2.3. CLI <a class="header-anchor" href="#cli-1" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>If you like to use the RabbitMQ cli, you can do it as follows:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">rabbitmqadmin <span class="token parameter variable">-u</span> rabbitmq <span class="token parameter variable">-p</span> password publish <span class="token assign-left variable">exchange</span><span class="token operator">=</span>my-exchange <span class="token assign-left variable">routing_key</span><span class="token operator">=</span>my-routing-key <span class="token assign-left variable">properties</span><span class="token operator">=</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>delivery_mode<span class="token entity" title="\&quot;">\"</span>:2}"</span> <span class="token assign-left variable">payload</span><span class="token operator">=</span><span class="token string">'test'</span></span></code></pre>

    </div><h2 id="set-a-fixed-hostname-for-rabbitmq-container" tabindex="-1">1.3. Set a fixed hostname for RabbitMQ container <a class="header-anchor" href="#set-a-fixed-hostname-for-rabbitmq-container" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<blockquote>
<p>Rabbitmq uses the hostname as part of the folder name in the mnesia directory. Maybe add a --hostname some-rabbit to your docker run?</p>
</blockquote>
<p><a href="https://github.com/docker-library/rabbitmq/issues/106#issuecomment-241882358" class="external-link" target="_blank">github.com</a></p>
<p>This is how the <em>mnesia</em> directory looks like after a few restarts if you <strong>don't</strong> set a hostname:</p>
<img src="/blog/2021-05-14-rabbitmq-persistence/rabbitmq-hostname.png" width="1394" height="1562" alt="undefined">
<p>Docker generates a new hostname every container run, and RabbitMQ takes it to create the directory structure.</p>
<p>Solution: Set the hostname via <code class="language-plain">--hostname rabbitmq</code> or in your <em>docker-compose.yml</em> via <code class="language-plain">hostname: rabbitmq</code>.</p>
<h1 id="metrics" tabindex="-1">2. Metrics <a class="header-anchor" href="#metrics" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>RabbitMQ has a <a href="https://www.rabbitmq.com/prometheus.html" class="external-link" target="_blank">big tutorial</a> on how to use their built-in prometheus-compatible metrics.</p>
<p>For my needs, adding this to my Prometheus <code class="language-plain">scrape_configs</code> was enough:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">  - job_name: 'rabbitmq-server'</span>
<span class="highlight-line">    static_configs:</span>
<span class="highlight-line">    - targets:</span>
<span class="highlight-line">        - 'rabbitmq:15692'</span></code></pre>

    </div><p>I use the <em>rabbitmq:3.8-management</em> docker image, which seems to already have
<a href="https://github.com/docker-library/rabbitmq/blob/e62f193dfcf9aee378e256cbbfae30363480c3a7/3.8/ubuntu/Dockerfile#L255" class="external-link" target="_blank">the metrics endpoint available</a>.</p>
<img src="/blog/2021-05-14-rabbitmq-persistence/rabbitmq-metrics.png" width="1513" height="895" alt="undefined">
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">$ docker ps</span>
<span class="highlight-line">63ae8f15f137 rabbitmq:3.8-management "docker-entrypoint.s…" 10 minutes ago Up 9 minutes rabbitmq</span>
<span class="highlight-line"></span>
<span class="highlight-line">$ docker exec -it rabbitmq rabbitmq-plugins list</span>
<span class="highlight-line">Listing plugins with pattern ".*" ...</span>
<span class="highlight-line"> Configured: E = explicitly enabled; e = implicitly enabled</span>
<span class="highlight-line"> | Status: * = running on rabbit@rabbitmq</span>
<span class="highlight-line"> |/</span>
<span class="highlight-line">[  ] rabbitmq_amqp1_0                  3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_auth_backend_cache       3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_auth_backend_http        3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_auth_backend_ldap        3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_auth_backend_oauth2      3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_auth_mechanism_ssl       3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_consistent_hash_exchange 3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_event_exchange           3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_federation               3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_federation_management    3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_jms_topic_exchange       3.8.16</span>
<span class="highlight-line">[E*] rabbitmq_management               3.8.16</span>
<span class="highlight-line">[e*] rabbitmq_management_agent         3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_mqtt                     3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_peer_discovery_aws       3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_peer_discovery_common    3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_peer_discovery_consul    3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_peer_discovery_etcd      3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_peer_discovery_k8s       3.8.16</span>
<span class="highlight-line">[E*] rabbitmq_prometheus               3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_random_exchange          3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_recent_history_exchange  3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_sharding                 3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_shovel                   3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_shovel_management        3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_stomp                    3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_top                      3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_tracing                  3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_trust_store              3.8.16</span>
<span class="highlight-line">[e*] rabbitmq_web_dispatch             3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_web_mqtt                 3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_web_mqtt_examples        3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_web_stomp                3.8.16</span>
<span class="highlight-line">[  ] rabbitmq_web_stomp_examples       3.8.16</span></code></pre>

    </div><p>Note that the <a href="https://github.com/rabbitmq/rabbitmq-server/blob/cb4e293cc7b8524cced8c7f84ba11023c61c84b5/deps/rabbitmq_prometheus/docker/docker-compose-overview.yml" class="external-link" target="_blank">official examples</a>
use a different docker image: <em>pivotalrabbitmq/rabbitmq-prometheus</em></p>


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
