
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samsung S4: Ad-Hoc WiFi (IBSS) on LineageOS 14.1</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>Samsung S4: Ad-Hoc WiFi (IBSS) on LineageOS 14.1</h1>
<div>
  <time class="postlist-date" datetime="2017-12-11T01:00:00.000+00:00">Dec 11, 2017</time>
</div>



<p>I did some investigations into <a href="/blog/2017-07-20-mesh-networks-on-android/">Mesh Networks</a> few weeks ago, in which I set up an Ad-Hoc WiFi network on my Samsung S4 phone.<br>
However, I used CyanogenMod 11, which is a little outdated.</p>
<p>I've received an e-mail from Andrew Hunter <a href="mailto:andrew.hunter@utexas.edu">andrew.hunter@utexas.edu</a> from Texas, who tried to run an Ad-Hoc network on the current LineageOS, 14.1.</p>
<p>For some reason, CyanogenMod decided to drop support for Ad-Hoc, so the current LineageOS doesn't have it.<br>
In fact, you won't be even able to see Ad-Hoc networks on the network list. They are filtered out.</p>
<p>So he tried to establish a connection by directly calling the Linux command in the adb shell ($SSID can be TestAdHoc and $FREQ 2412 for example):</p>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line">iw wlan0 <span class="token builtin class-name">set</span> <span class="token builtin class-name">type</span> ibss</span>
<span class="highlight-line">iw wlan0 ibss <span class="token function">join</span> <span class="token variable">$SSID</span> <span class="token variable">$FREQ</span></span></code></pre>
<p>However, this results in an error message:</p>
<blockquote>
<p>command failed: File table overflow (-23)</p>
</blockquote>
<p>For some reason we need a special firmware for the WiFi chip.</p>
<p>Andrew had this problem and asked me if I knew any details on how to fix it.<br>
Well, I didn't. But after several trials and errors he made great progress and got it running!</p>
<figure class="quote">
<blockquote>
<p>If you don't load the IBSS firmware, the join command will fail. Also, if you try to set the frequency in IBSS mode without the IBSS firmware loaded, it might crash the device, and restart.<br>
In /sys/module/dhd/parameters/ are the files firmware_path and nvram_path. These two are empty by default and, I believe, are cleared whenever wifi is brought down. If you populate these before bringing the interface backup, you cause the firmware and driver to assume certain settings. The folder /system/etc/wifi has a variety of firmware and nvram settings you can select.<br>
It may be that populating path variables for module loading is a standard paradigm, but I was not aware of it; I merely guessed based on module loading commands I had seen years ago. As I said, I expected to be using insmod and rmmod to set such things, but these aren't available here.<br>
This isn't hard once you know it, but I'm rather surprised I couldn't find any discussion of this.</p>
</blockquote>
<figcaption class="quote-attribution">Andrew</figcaption>
</figure>
<p>Luckily, the IBSS firmware is part of the LineageOS image and already on the phone.
In order to load it, open up a shell on your rooted phone:</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">adb shell</span></span></span>
<span class="highlight-line"><span class="token output">jfltexx:/ $ su</span>
<span class="highlight-line">jfltexx:/ #</span></code></pre>
<p>Now open the network view on the phone and disable WiFi.</p>
<p>Execute the following commands:</p>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token comment"># WiFi should be down already, just make sure it is</span></span>
<span class="highlight-line"><span class="token function">ifconfig</span> wlan0 down</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Load the correct firmware files for WiFi Ad-Hoc (IBSS)</span></span>
<span class="highlight-line"><span class="token builtin class-name">echo</span> <span class="token string">"/system/etc/wifi/bcmdhd_ibss.bin"</span> <span class="token operator">>></span> /sys/module/dhd/parameters/firmware_path</span>
<span class="highlight-line"><span class="token builtin class-name">echo</span> <span class="token string">"/system/etc/wifi/nvram_net.txt"</span> <span class="token operator">>></span> /sys/module/dhd/parameters/nvram_path</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Start WiFi again and assign a static IP address</span></span>
<span class="highlight-line"><span class="token function">ifconfig</span> wlan0 <span class="token number">10.0</span>.0.1 netmask <span class="token number">255.255</span>.255.0 up</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Set mode to WiFi Ad-Hoc (IBSS)</span></span>
<span class="highlight-line">iw wlan0 <span class="token builtin class-name">set</span> <span class="token builtin class-name">type</span> ibss</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Join or create the network</span></span>
<span class="highlight-line">iw wlan0 ibss <span class="token function">join</span> <span class="token variable">$SSID</span> <span class="token variable">$FREQ</span></span></code></pre>
<p>The new WiFi with the SSID should now show up on other devices when you scan for open networks.</p>
<p><strong>Thank you Andrew for the work you put into this and for sharing the knowledge!</strong></p>
<h1 id="why-did-it-work-on-cyanogenmod-11%3F" tabindex="-1">1. Why did it work on CyanogenMod 11? <a class="header-anchor" href="#why-did-it-work-on-cyanogenmod-11%3F" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>thinktube.com created patches for CM 11 and 12.
These patches included a GUI to select/create a WiFi Ad-Hoc network, but also <a href="http://www.thinktube.com/files/android-ibss/patches/kernel-samsung-tuna-0001-bcmdhd-Enable-Ad-Hoc-IBSS-mode.patch" class="external-link" target="_blank">patched the bcmdhd driver</a>.
Please check their page here for details:</p>
<p><a href="http://www.thinktube.com/android-tech/46-android-wifi-ibss" class="external-link" target="_blank">http://www.thinktube.com/android-tech/46-android-wifi-ibss</a></p>
<p>It would also be very interesting to know the reasons for the dropped support of Ad-Hoc in newer versions of CyanogenMod/LineageOS.
Most likely, thinktube.com just didn't provide patches.</p>
<h1 id="list-of-firmwares" tabindex="-1">2. List of firmwares <a class="header-anchor" href="#list-of-firmwares" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<ul>
<li>/system/etc/wifi/bcmdhd_apsta.bin</li>
<li>/system/etc/wifi/bcmdhd_ibss.bin</li>
<li>/system/etc/wifi/bcmdhd_mfg.bin</li>
<li>/system/etc/wifi/bcmdhd_sta.bin</li>
</ul>
<p>I've used lineage-14.1-20171206-nightly-jfltexx-signed.zip</p>
<img src="/blog/2017-12-11-samsung-s4-adhoc-on-lineage14.1/olsr.png" width="1440" height="900" alt="undefined">


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
