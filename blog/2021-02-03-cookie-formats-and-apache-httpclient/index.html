
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie formats and Apache HttpClient</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>Cookie formats and Apache HttpClient</h1>
<div>
  <time class="postlist-date" datetime="2021-02-03T18:00:00.000+00:00">Feb 3, 2021</time>
</div>



<p>I've spent some time isolating a bug in the company's cookie proxy.
This is about the <em>expires</em> part of a cookie.</p>
<h1 id="two-formats" tabindex="-1">1. Two formats <a class="header-anchor" href="#two-formats" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Let's see what <strong>google.com</strong> uses:</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line">$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> http://www.google.com</span>
<span class="highlight-line">*   Trying 2a00:1450:4005:800::2004:80<span class="token punctuation">..</span>.</span>
<span class="highlight-line">* Connected to www.google.com <span class="token punctuation">(</span>2a00:1450:4005:800::2004<span class="token punctuation">)</span> port <span class="token number">80</span> <span class="token punctuation">(</span><span class="token comment">#0)</span></span>
<span class="highlight-line"><span class="token operator">></span> GET / HTTP/1.1</span>
<span class="highlight-line"><span class="token operator">></span> Host: www.google.com</span>
<span class="highlight-line"><span class="token operator">></span> User-Agent: curl/7.74.0</span>
<span class="highlight-line"><span class="token operator">></span> Accept: */*</span>
<span class="highlight-line"><span class="token operator">></span> </span>
<span class="highlight-line">* Mark bundle as not supporting multiuse</span>
<span class="highlight-line"><span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK</span>
<span class="highlight-line"><span class="token operator">&lt;</span> Date: Thu, 04 Feb <span class="token number">2021</span> <span class="token number">14</span>:52:31 GMT</span>
<span class="highlight-line"><span class="token operator">&lt;</span> Expires: <span class="token parameter variable">-1</span></span>
<span class="highlight-line"><span class="token operator">&lt;</span> Cache-Control: private, max-age<span class="token operator">=</span><span class="token number">0</span></span>
<span class="highlight-line"><span class="token operator">&lt;</span> Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>ISO-8859-1</span>
<span class="highlight-line"><span class="token operator">&lt;</span> P3P: <span class="token assign-left variable">CP</span><span class="token operator">=</span><span class="token string">"This is not a P3P policy! See g.co/p3phelp for more info."</span></span>
<span class="highlight-line"><span class="token operator">&lt;</span> Server: gws</span>
<span class="highlight-line"><span class="token operator">&lt;</span> X-XSS-Protection: <span class="token number">0</span></span>
<span class="highlight-line"><span class="token operator">&lt;</span> X-Frame-Options: SAMEORIGIN</span>
<span class="highlight-line"><span class="token operator">&lt;</span> Set-Cookie: <span class="token assign-left variable">NID</span><span class="token operator">=</span><span class="token number">208</span><span class="token operator">=</span>Q71yKqzPX7wekeaMyaa-RndCAZz6pLnozTJRLprMjuZzuImXnlCCXFoqoRoeuxrjn7pk8l2gIesgE5LITdauT_AnYm3jmUlwkqLW1LN4igl8zDVBW5UzTJUizdVeiyuIy4F7RfABvuLUI-dIXlQItQbiYCtTNQTzBh7lEwtn5YM<span class="token punctuation">;</span> <span class="token assign-left variable">expires</span><span class="token operator">=</span>Fri, 06-Aug-2021 <span class="token number">14</span>:52:31 GMT<span class="token punctuation">;</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/<span class="token punctuation">;</span> <span class="token assign-left variable">domain</span><span class="token operator">=</span>.google.com<span class="token punctuation">;</span> HttpOnly</span>
<span class="highlight-line"><span class="token operator">&lt;</span> Accept-Ranges: none</span>
<span class="highlight-line"><span class="token operator">&lt;</span> Vary: Accept-Encoding</span>
<span class="highlight-line"><span class="token operator">&lt;</span> Transfer-Encoding: chunked</span>
<span class="highlight-line"><span class="token operator">&lt;</span> </span>
<span class="highlight-line"><span class="token operator">&lt;</span><span class="token operator">!</span>doctype html<span class="token operator">></span><span class="token operator">&lt;</span>html and so on<span class="token punctuation">..</span></span></code></pre>
<p>See? It says <strong>expires=Fri, 06-Aug-2021 14:52:31 GMT</strong>.</p>
<p>This is interesting, as there apparently are two common ways to format that date.</p>
<ul>
<li>The Cookie date, described in <a href="https://tools.ietf.org/html/rfc6265#section-5.1.1" class="external-link" target="_blank">RFC 6265</a><br>
This is pretty much the HTTP date (described in <a href="https://tools.ietf.org/html/rfc7231#section-7.1.1.2" class="external-link" target="_blank">RFC 7231</a>).<br>
You will also find that format on other HTTP headers, for example in the <code class="language-plain">If-Modified-Since</code> header.<br>
Example: <code class="language-plain">Tue, 15 Jan 2013 21:47:38 GMT</code></li>
<li>Netscape's way, described in <a href="https://tools.ietf.org/html/rfc2109#section-10.1.2" class="external-link" target="_blank">RFC 2109</a> (from 1997, obsolete)<br>
Example: <code class="language-plain">Tue, 15-Jan-2013 21:47:38 GMT</code></li>
</ul>
<p>You can note two things:</p>
<ul>
<li>The only difference is the hyphens inbetween.</li>
<li>Google uses the RFC 2109 format.</li>
</ul>
<h1 id="apache-httpclient" tabindex="-1">2. Apache HttpClient <a class="header-anchor" href="#apache-httpclient" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>A very widely used client library is HttpClient. Now here it is getting interesting.
Because if you just use it out-of-the-box, HttpClient does not support the RFC 6265 and throws an exception instead:</p>
<p>Let's have a look at an example (I use HttpClient 4.5.13):</p>
<pre class="language-java"><code class="language-java"><span class="highlight-line"><span class="token class-name">CookieSpec</span> defaultCookieSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token class-name">BasicHeader</span> setCookieHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicHeader</span><span class="token punctuation">(</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">,</span> <span class="token string">"testcookie=myvalue; Max-Age=43200; Expires=Wed, 03-Feb-2021 21:57:56 GMT; Path=/; Secure; HttpOnly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">defaultCookieSpec<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>setCookieHeader<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CookieOrigin</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>This code, with a cookie in the RFC 2109 format, works fine. HttpClient can parse you the header into a list of Cookie objects.</p>
<p>Let's try the (newer) RFC 6265 format:</p>
<pre class="language-java"><code class="language-java"><span class="highlight-line"><span class="token class-name">BasicHeader</span> setCookieHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicHeader</span><span class="token punctuation">(</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">,</span> <span class="token string">"testcookie=myvalue; Max-Age=43200; Expires=Fri, 29 Jan 2021 22:08:53 GMT; Path=/; Secure; HttpOnly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">defaultCookieSpec<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>setCookieHeader<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CookieOrigin</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Boom! <strong>MalformedCookieException: Invalid 'expires' attribute: Fri, 29 Jan 2021 22:08:53 GMT</strong>.</p>
<p>Some googling, and you find a solution on <a href="https://stackoverflow.com/a/40697322" class="external-link" target="_blank">stackoverflow.com</a>:</p>
<blockquote>
<p>The default HttpClient has difficulty understanding the latest RFC-compliant headers.<br>
Instead of hiding the warning, just switch to a standard cookie spec [...]</p>
</blockquote>
<p><strong>Wow!</strong> I'm a bit disappointed HttpClient (by default) doesn't accept cookies, which are perfectly fine by the latest RFC. :(
Also, I find it confusing there is a <em>DEFAULT</em> and a <em>STANDARD</em> <a href="https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/client/config/CookieSpecs.html" class="external-link" target="_blank">CookieSpec</a>.</p>
<p>Why is standard not the default?<br>
Anyway, after the change, it worked well.</p>
<p>There is also a <a href="https://issues.apache.org/jira/browse/HTTPCLIENT-1763" class="external-link" target="_blank">bug ticket</a> in the HttpClient bug tracker.<br>
<strong>But wow again!</strong> It has been <em>resolved</em> with the reason: <em>Invalid</em> :/</p>
<p>For completeness, here is the example above with the standard spec (it uses RFC6265LaxSpec as implementation):</p>
<pre class="language-java"><code class="language-java"><span class="highlight-line"><span class="token class-name">CookieSpec</span> standardCookieSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RFC6265LaxSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token class-name">BasicHeader</span> setCookieHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicHeader</span><span class="token punctuation">(</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">,</span> <span class="token string">"testcookie=myvalue; Max-Age=43200; Expires=Fri, 29 Jan 2021 22:08:53 GMT; Path=/; Secure; HttpOnly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">standardCookieSpec<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>setCookieHeader<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CookieOrigin</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Note: The standard spec can also parse the RFC 2109 formatted cookie!</p>
<p>My personal preference: everything should just use ISO 8601 for date formatting (even http).
But that's not gonna happen soon. ;)</p>


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
