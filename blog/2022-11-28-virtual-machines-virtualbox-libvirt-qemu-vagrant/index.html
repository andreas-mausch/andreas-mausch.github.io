
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual machines: VirtualBox vs. libvirt, QEMU on M1, vagrant</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>Virtual machines: VirtualBox vs. libvirt, QEMU on M1, vagrant</h1>
<div>
  <time class="postlist-date" datetime="2022-11-28T19:00:00.000+00:00">Nov 28, 2022</time>
  <ul class="tags">
    
        
          <li><a href="/blog/tags/apple%20silicon">#apple silicon</a></li>
        
    
        
          <li><a href="/blog/tags/arm">#arm</a></li>
        
    
        
          <li><a href="/blog/tags/cross-compilation">#cross-compilation</a></li>
        
    
        
          <li><a href="/blog/tags/libvirt">#libvirt</a></li>
        
    
        
          <li><a href="/blog/tags/m1">#m1</a></li>
        
    
        
    
        
          <li><a href="/blog/tags/qcow2">#qcow2</a></li>
        
    
        
          <li><a href="/blog/tags/qemu">#qemu</a></li>
        
    
        
          <li><a href="/blog/tags/vagrant">#vagrant</a></li>
        
    
        
          <li><a href="/blog/tags/virtual%20machines">#virtual machines</a></li>
        
    
        
          <li><a href="/blog/tags/virtualbox">#virtualbox</a></li>
        
    
        
          <li><a href="/blog/tags/vms">#vms</a></li>
        
    
  </ul>
</div>


  <aside>
    <nav class="toc">
                <ol>
                    
                    <li><a href="#what-i-use-virtualization-for">1. What I use virtualization for</a>
            		</li>

                    <li><a href="#virtualbox">2. VirtualBox</a>
            		</li>

                    <li><a href="#apple-silicon-(m1%2Fm2)%2C-alternatives%3F">3. Apple Silicon (M1/M2), alternatives?</a>
            		</li>

                    <li><a href="#qemu">4. QEMU</a>
            
                <ol>
                    
                    <li><a href="#cross-compiling-example-(arm)">4.1. Cross-compiling example (ARM)</a>
            
                <ol>
                    
                    <li><a href="#assembly-example">4.1.1. Assembly example</a>
            		</li>

                    <li><a href="#c-example-(gcc)">4.1.2. C example (gcc)</a>
            		</li>

                    <li><a href="#run-arm-binary-on-x86_64-system">4.1.3. Run ARM binary on x86_64 system</a>
            		</li>

                    <li><a href="#virtualization-vs.-emulation">4.1.4. Virtualization vs. Emulation</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#check-support-for-kvm">4.2. Check support for KVM</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#libvirt-and-virt-manager">5. libvirt and virt-manager</a>
            
                <ol>
                    
                    <li><a href="#why-not-just-pure-qemu%3F">5.1. Why not just pure QEMU?</a>
            		</li>

                    <li><a href="#install-libvirt%2C-virt-manager">5.2. Install libvirt, virt-manager</a>
            		</li>

                    <li><a href="#permissions">5.3. Permissions</a>
            		</li>

                    <li><a href="#machine-hostname-resolving-(dns)">5.4. Machine hostname resolving (DNS)</a>
            
                <ol>
                    
                    <li><a href="#dns-service-via-systemd">5.4.1. DNS service via systemd</a>
            		</li>

                    <li><a href="#libvirt-nss">5.4.2. libvirt-nss</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#qemu%3A%2F%2F%2Fsystem-vs-qemu%3A%2F%2F%2Fsession">5.5. qemu:///system vs qemu:///session</a>
            		</li>

                    <li><a href="#useful-virsh-cli-commands">5.6. Useful virsh CLI commands</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#vagrant">6. vagrant</a>
            		</li>

                    <li><a href="#vagrant-and-windows">7. vagrant and Windows</a>
            
                <ol>
                    
                    <li><a href="#winrm-problem%3A-openssl-md4">7.1. WinRM problem: OpenSSL MD4</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#apple-silicon">8. Apple Silicon</a>
            		</li>

                    <li><a href="#libvirt-vs.-virtualbox">9. libvirt vs. VirtualBox</a>
            		</li>
                </ol>
            </nav>
  </aside>


<p>I've used various virtualization technologies in the past and have now switched to
<a href="https://libvirt.org/" class="external-link" target="_blank">libvirt</a> as my main tool and would like to explain why.</p>
<h1 id="what-i-use-virtualization-for" tabindex="-1">1. What I use virtualization for <a class="header-anchor" href="#what-i-use-virtualization-for" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I use virtual machines..</p>
<ul>
<li>..as an isolated playground for new technologies.</li>
<li>..to build programs for different operation systems or architectures
(<a href="https://github.com/andreas-mausch/whatsapp-viewer" class="external-link" target="_blank">whatsapp-viewer</a> for Windows,
<a href="https://gitlab.com/andreas-mausch/moonwatch" class="external-link" target="_blank">moonwatch</a> for Samsung Smartwatch).</li>
<li>..to have one machine for a specific set of tasks, for example everything regarding taxes.
I can be sure the programs will still work, regardless of how many (possibly incompatible)
updates I apply on my main system.</li>
<li>..on macOS to run Docker</li>
</ul>
<p>For me the most important point about them is to have a portable setup.
I want to be able to quickly switch to a new system and still be able to continue working with my boxes.</p>
<p>I will skip Docker here, because I use it for different reasons.</p>
<h1 id="virtualbox" tabindex="-1">2. VirtualBox <a class="header-anchor" href="#virtualbox" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>For my very first virtual machines I've used Connectix Virtual PC, which was just a 10 MB binary
with a limited feature set, but it was super easy to use and
did it's job very well for my purposes.</p>
<p>After that I've been using VirtualBox for many years and was quite happy with it.
Sometimes I had some issues to get the right packages installed.
There was <code class="language-plain">virtualbox</code>, <code class="language-plain">virtualbox-host-dkms</code>, <code class="language-plain">virtualbox-guest-iso</code> and <code class="language-plain">virtualbox-ext-oracle</code>, which was quite confusing.
The host-dkms also had to be rebuilt everytime the kernel changed, which took some time.
Also, the licensing model wasn't completely free.</p>
<p>However, overall it was an easy method to get everything set up.</p>
<h1 id="apple-silicon-(m1%2Fm2)%2C-alternatives%3F" tabindex="-1">3. Apple Silicon (M1/M2), alternatives? <a class="header-anchor" href="#apple-silicon-(m1%2Fm2)%2C-alternatives%3F" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Until..Apple Silicon came around, and VirtualBox doesn't and will not support running x86 boxes on it.
I am aware the performance of an emulated x86 system will be aweful.
However, sometimes I just have a good feeling I <strong>could</strong> run a full build of my favorite software,
despite poor performance, instead of not being able to build it at all.</p>
<p>That's why I started to look for a way to run Windows on Apple Silicon.
There is <a href="https://mac.getutm.app/" class="external-link" target="_blank">UTM</a>, which is like a QEMU GUI frontend for macOS only (huh?).
But since we use libvirt and virt-manager at work, I thought it would be worth a shot.
It would also be a os-independent solution, which I hope could last very long.</p>
<h1 id="qemu" tabindex="-1">4. QEMU <a class="header-anchor" href="#qemu" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>But first, let's take a short step back.
I tested libvirt with the QEMU hypervisor driver. So what is QEMU?</p>
<p>QEMU is an emulator which allows you to run x86 code on an ARM machine and vice versa.
It also supports a large list of additional platforms and offers hardware-assisted virtualization (KVM or HVF).</p>
<p>When I developed a small game for the PlayStation Portable back in the day it was the first time I used cross compiling.
The PSP has a MIPS32 R4000 processor and in order to compile your code for it your either had to compile it on the PSP itself,
or use a compiler which supports cross-compilation. I found some tutorials on how to write C code and compile it to MIPS on a x86 machine.
There was a whole community around it that reversed all the graphical APIs and I could write simple OpenGL calls to use them via their SDK.
Great times.</p>
<p>Later, I used it to build programs for the Raspberry Pi and Arduino.</p>
<h2 id="cross-compiling-example-(arm)" tabindex="-1">4.1. Cross-compiling example (ARM) <a class="header-anchor" href="#cross-compiling-example-(arm)" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Here is a small example how to cross-compile a simple assembler Hello World for ARM architecture.</p>
<p>First, install a toolchain for</p>
<ul>
<li>an assembler</li>
<li>a linker</li>
<li>gcc</li>
<li>and some other tools like objdump</li>
</ul>
<p>You can either use the precompiled <code class="language-plain">arm-none-linux-gnueabihf-toolchain-bin</code> (you can find a more recent version
<a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads" class="external-link" target="_blank">here</a>)
or compile it yourself by using <code class="language-plain">arm-linux-gnueabihf-gcc</code> (it will take some time, though, &gt;1h on my machine).</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">yay <span class="token parameter variable">-S</span> arm-linux-gnueabihf-gcc</span></code></pre>

    </div><p>This costs some time and needed manual adjustments.
Check the <a href="https://aur.archlinux.org/packages/arm-linux-gnueabihf-gcc" class="external-link" target="_blank">AUR page</a> for instructions.</p>
<h3 id="assembly-example" tabindex="-1">4.1.1. Assembly example <a class="header-anchor" href="#assembly-example" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>Let's take this ARM 32-bit Hello World program:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-arm-asm"><code data-filename="example.as" class="language-arm-asm"><span class="highlight-line">.section .text</span>
<span class="highlight-line">.global _start</span>
<span class="highlight-line"></span>
<span class="highlight-line">_start:</span>
<span class="highlight-line"><span class="token operator">/</span><span class="token operator">*</span> syscall write<span class="token punctuation">(</span>int fd<span class="token punctuation">,</span> const void <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token operator">/</span></span>
<span class="highlight-line">    mov <span class="token register symbol">r0</span><span class="token punctuation">,</span> <span class="token operator">#</span><span class="token number">1</span> </span>
<span class="highlight-line">    ldr <span class="token register symbol">r1</span><span class="token punctuation">,</span> <span class="token operator">=</span>msg </span>
<span class="highlight-line">    ldr <span class="token register symbol">r2</span><span class="token punctuation">,</span> <span class="token operator">=</span>len </span>
<span class="highlight-line">    mov <span class="token register symbol">r7</span><span class="token punctuation">,</span> <span class="token operator">#</span><span class="token number">4</span> </span>
<span class="highlight-line">    svc <span class="token operator">#</span><span class="token number">0</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token operator">/</span><span class="token operator">*</span> syscall exit<span class="token punctuation">(</span>int status<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token operator">/</span></span>
<span class="highlight-line">    mov <span class="token register symbol">r0</span><span class="token punctuation">,</span> <span class="token operator">#</span><span class="token number">0</span> </span>
<span class="highlight-line">    mov <span class="token register symbol">r7</span><span class="token punctuation">,</span> <span class="token operator">#</span><span class="token number">1</span> </span>
<span class="highlight-line">    svc <span class="token operator">#</span><span class="token number">0</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">msg:</span>
<span class="highlight-line">.ascii <span class="token string">"Hello, ARM32!\n"</span></span>
<span class="highlight-line">len <span class="token operator">=</span> . <span class="token operator">-</span> msg</span></code></pre>

    </div><p>Compile and link the program as follows</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">arm-linux-gnueabihf-as <span class="token parameter variable">-o</span> example-as.out example.as</span></span></span>
<span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">arm-linux-gnueabihf-ld <span class="token parameter variable">-o</span> example-as example-as.out</span></span></span>
<span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">file</span> ./example-as</span></span></span>
<span class="highlight-line"><span class="token output">./example-as: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped</span></code></pre>

    </div><h3 id="c-example-(gcc)" tabindex="-1">4.1.2. C example (gcc) <a class="header-anchor" href="#c-example-(gcc)" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-c"><code data-filename="example.c" class="language-c"><span class="highlight-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ARM C Test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  <span class="token keyword">return</span> <span class="token number">99</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>

    </div><div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">arm-linux-gnueabihf-gcc <span class="token parameter variable">-static</span> <span class="token parameter variable">-o</span> example-c example.c</span></code></pre>

    </div><p>Note: If you don't statically link the file, you might see <a href="https://stackoverflow.com/questions/47787562/u-boot-lib-ld-linux-armhf-so-3-no-such-file-or-directory" class="external-link" target="_blank">this error</a>:</p>
<blockquote>
<p>qemu-arm: Could not open '/lib/ld-linux-armhf.so.3': No such file or directory</p>
</blockquote>
<h3 id="run-arm-binary-on-x86_64-system" tabindex="-1">4.1.3. Run ARM binary on x86_64 system <a class="header-anchor" href="#run-arm-binary-on-x86_64-system" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>Now QEMU can run the ARM binary code on a x86_64 CPU.
You can run a single binary by using <a href="https://qemu-project.gitlab.io/qemu/user/main.html" class="external-link" target="_blank">User Mode emulation</a>
or run a full-blown system via the <a href="https://qemu-project.gitlab.io/qemu/system/index.html" class="external-link" target="_blank">System emulation</a>.
With the latter, you can run Windows XP on an ARM CPU, for example.
We will use the User Mode emulation in our example, though.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">sudo</span> pacman <span class="token parameter variable">-S</span> qemu-user</span></span></span>
<span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">./example-as</span></span></span>
<span class="highlight-line"><span class="token output">exec: Failed to execute process: './example-as' the file could not be run by the operating system.</span>
<span class="highlight-line"></span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">qemu-arm ./example-as</span></span></span>
<span class="highlight-line"><span class="token output">Hello, ARM32!</span></code></pre>

    </div><div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">qemu-arm ./example-c</span></span></span>
<span class="highlight-line"><span class="token output">ARM C Test</span>
<span class="highlight-line"></span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token builtin class-name">echo</span> <span class="token variable">$status</span></span></span></span>
<span class="highlight-line"><span class="token output">99</span></code></pre>

    </div><h3 id="virtualization-vs.-emulation" tabindex="-1">4.1.4. Virtualization vs. Emulation <a class="header-anchor" href="#virtualization-vs.-emulation" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>A short note on this:
I'm sure most of you are aware of the differences (especially performance-wise).
My goal is to have a virtual machine running, by either emulation or virtualization.
Since both can be used to accomplish this, this article deals with both terms.</p>
<h2 id="check-support-for-kvm" tabindex="-1">4.2. Check support for KVM <a class="header-anchor" href="#check-support-for-kvm" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>To check support for hardware-assisted virtualization via KVM, run these commands:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token assign-left variable"><span class="token environment constant">LC_ALL</span></span><span class="token operator">=</span>C lscpu <span class="token operator">|</span> <span class="token function">grep</span> Virtualization</span>
<span class="highlight-line">zgrep CONFIG_KVM /proc/config.gz</span></code></pre>

    </div><h1 id="libvirt-and-virt-manager" tabindex="-1">5. libvirt and virt-manager <a class="header-anchor" href="#libvirt-and-virt-manager" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Back to virtualization and trying the alternative for VirtualBox: libvirt.</p>
<img src="/blog/2022-11-28-virtual-machines-virtualbox-libvirt-qemu-vagrant/libvirt-winxp.jpg" width="1224" height="1004" alt="undefined">
<p>Starting off with libvirt was..not super easy.
There are a lot of different tools and libraries and it feels like a bunch of everything at the beginning.</p>
<p><code class="language-plain">libvirt</code>, <code class="language-plain">virsh</code>, <code class="language-plain">virt-install</code>, <code class="language-plain">virt-manager</code>, <code class="language-plain">libvirt-nss</code>, <code class="language-plain">qemu-system-x86_64</code>, <code class="language-plain">qemu-img</code>, <code class="language-plain">cloud-init</code>.. uff.</p>
<p>Let me try to break this down a bit:</p>
<ul>
<li><strong>QEMU</strong>: as mentioned above, a machine emulator and virtualizer. Used by libvirt behind the scenes
(libvirt can also use other providers than QEMU, but we will use it in this article).
<ul>
<li>qemu-arm: The user mode emulation for ARM</li>
<li>qemu-system-x86_64: The whole system emulation for x86_64</li>
<li>qemu-img: a CLI tool to create hard-disk images</li>
</ul>
</li>
<li><strong>libvirt</strong>: a toolkit to manage virtualization platforms
<ul>
<li>virsh: a CLI tool to manage libvirt's machines</li>
<li>virt-install: a CLI tool to create a new libvirt machine</li>
<li>virt-manager: a GUI tool to view, start and stop libvirt's machines</li>
<li>libvirt-nss: an extension module to access a libvirt machine by it's hostname</li>
</ul>
</li>
<li><strong>cloud-init</strong>: A tool to set up a brand new machine. It will set up networking, SSH keys, create users and so on.</li>
</ul>
<p>I have used these versions for the commands in this post:</p>
<ul>
<li>GCC: 12</li>
<li>arm gnueabihf binutils: 2.38</li>
<li>QEMU: 7.1.0</li>
<li>libvirt: 8.9.0</li>
<li>virt-manager / virt-install: 4.1.0</li>
</ul>
<h2 id="why-not-just-pure-qemu%3F" tabindex="-1">5.1. Why not just pure QEMU? <a class="header-anchor" href="#why-not-just-pure-qemu%3F" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>QEMU works great on it's own.
Here is a small example how to set up a Windows XP box.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">qemu-img create <span class="token parameter variable">-f</span> qcow2 windows.qcow2 30G</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Boot from iso and run Windows Setup</span></span>
<span class="highlight-line">qemu-system-x86_64 <span class="token parameter variable">-m</span> 2G <span class="token punctuation">[</span>-machine <span class="token assign-left variable">type</span><span class="token operator">=</span>q35<span class="token punctuation">]</span> <span class="token parameter variable">-smp</span> <span class="token number">2</span> <span class="token parameter variable">-vga</span> virtio <span class="token parameter variable">-usb</span> <span class="token parameter variable">-device</span> usb-tablet <span class="token parameter variable">-display</span> default,show-cursor<span class="token operator">=</span>on <span class="token parameter variable">-hda</span> windows.qcow2 <span class="token parameter variable">-cdrom</span> ~/Downloads/en_windows_xp_professional_with_service_pack_3_x86_cd_vl_x14-73974.iso</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># After the installation is done, run from hard disk</span></span>
<span class="highlight-line">qemu-system-x86_64 <span class="token parameter variable">-m</span> 2G <span class="token parameter variable">-smp</span> <span class="token number">2</span> <span class="token parameter variable">-vga</span> virtio <span class="token parameter variable">-usb</span> <span class="token parameter variable">-device</span> usb-tablet <span class="token parameter variable">-display</span> default,show-cursor<span class="token operator">=</span>on <span class="token parameter variable">-hda</span> windows.qcow2</span></code></pre>

    </div><p>QEMU by default only works with a BIOS.
If you wish to run a box with UEFI boot, you need to specify a different firmware file:
<code class="language-plain">-bios /usr/share/edk2-ovmf/x64/OVMF.fd</code></p>
<p>Other interesting CLI options are:</p>
<ul>
<li><code class="language-plain">-machine type=q35</code></li>
<li><code class="language-plain">-cpu qemu64-v1</code></li>
<li><code class="language-plain">-accel kvm</code></li>
</ul>
<p>The limitations of using QEMU directly is that it doesn' store the configuration for a box.
You would have to remember all CLI options for each machine, and also which hard-disk image to use.</p>
<h2 id="install-libvirt%2C-virt-manager" tabindex="-1">5.2. Install libvirt, virt-manager <a class="header-anchor" href="#install-libvirt%2C-virt-manager" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p><code class="language-plain">libvirt</code> addtionally helps you to save the settings of the box, set up the network,
and it supports different providers than just QEMU.</p>
<p>It stores the configuration for each box in a XML file.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">sudo</span> pacman <span class="token parameter variable">-S</span> cloud-image-utils virt-install virt-manager qemu qemu-ui-gtk</span>
<span class="highlight-line"><span class="token function">sudo</span> systemctl status libvirtd.service</span>
<span class="highlight-line"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> libvirtd.service</span>
<span class="highlight-line"><span class="token function">sudo</span> systemctl start libvirtd.service</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/libvirt/libvirtd.conf</span>
<span class="highlight-line"><span class="token comment"># Edit the file and set the two lines below (uncomment them):</span></span>
<span class="highlight-line"><span class="token comment"># unix_sock_group = "libvirt"</span></span>
<span class="highlight-line"><span class="token comment"># unix_sock_rw_perms = "0770"</span></span>
<span class="highlight-line"><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-G</span> libvirt <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span></span>
<span class="highlight-line">newgrp libvirt</span>
<span class="highlight-line"><span class="token function">sudo</span> systemctl restart libvirtd.service</span></code></pre>

    </div><h2 id="permissions" tabindex="-1">5.3. Permissions <a class="header-anchor" href="#permissions" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>I got some <em>Access denied</em> errors when trying to run a virtual box where the image file was in my home directory.
The problem was that the user <code class="language-plain">libvirt-qemu</code> needs to have access to that image.</p>
<p>There are <a href="https://ostechnix.com/solved-cannot-access-storage-file-permission-denied-error-in-kvm-libvirt/" class="external-link" target="_blank">several ways</a>
to solve this. You could..</p>
<ol>
<li>..move the file into a directory which is accessible by you and libvirt-qemu.</li>
<li>..switch the user qemu uses inside <code class="language-plain">/etc/libvirt/qemu.conf</code>.</li>
<li>..grant libvirt-qemu access to that file:<br>
<code class="language-plain">sudo setfacl -m u:libvirt-qemu:rx /home/user/image.qcow2</code></li>
</ol>
<h2 id="machine-hostname-resolving-(dns)" tabindex="-1">5.4. Machine hostname resolving (DNS) <a class="header-anchor" href="#machine-hostname-resolving-(dns)" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>To access boxes by their hostname, you can either set up a DNS service, or use a
module which comes with libvirt: <code class="language-plain">libvirt-nss</code>.</p>
<h3 id="dns-service-via-systemd" tabindex="-1">5.4.1. DNS service via systemd <a class="header-anchor" href="#dns-service-via-systemd" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>Change the systemd resolver config as follows:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code data-filename="/etc/systemd/resolved.conf" class="language-plain"><span class="highlight-line">[Resolve]</span>
<span class="highlight-line">DNS=192.168.122.1</span>
<span class="highlight-line">Domains=~libvirt</span></code></pre>

    </div><p>The IP address in the DNS field needs to match your libvirt network configuration (see below).
Also, you box must have set the correct domain.</p>
<p>After editing the file you need to restart the resolver</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">sudo systemctl restart systemd-resolved.service</span></code></pre>

    </div><p>Then, you can access your machine by it's hostname, for example <code class="language-plain">my-box.libvirt</code>.</p>
<h3 id="libvirt-nss" tabindex="-1">5.4.2. libvirt-nss <a class="header-anchor" href="#libvirt-nss" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>I prefer this <code class="language-plain">libvirt-nss</code> method, though.
It's already included in the Arch package, so all I had to do to use it was to modify my config file:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code data-filename="/etc/nsswitch.conf" class="language-plain"><span class="highlight-line">// ...</span>
<span class="highlight-line">hosts: files libvirt libvirt_guest dns</span>
<span class="highlight-line">// ...</span></code></pre>

    </div><p>See <a href="https://libvirt.org/nss.html" class="external-link" target="_blank">this page</a> for full instructions.</p>
<p>Note: The module only works for the hostname, not for the FQDN hostname.domain.
I solved it for myself by naming the machine hostname.domain.
Then, I can access the machine by both names, <code class="language-plain">hostname</code> and <code class="language-plain">hostname.domain</code>.</p>
<h2 id="qemu%3A%2F%2F%2Fsystem-vs-qemu%3A%2F%2F%2Fsession" tabindex="-1">5.5. qemu:///system vs qemu:///session <a class="header-anchor" href="#qemu%3A%2F%2F%2Fsystem-vs-qemu%3A%2F%2F%2Fsession" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Regarding virsh: Some things, like setting up a network, can only be done with QEMU in system mode.
See <a href="https://blog.wikichoon.com/2016/01/qemusystem-vs-qemusession.html" class="external-link" target="_blank">this post</a></p>
<p>So after seeing a lot of <em>Access denied</em> messages, I've decided to use <code class="language-plain">qemu:///system</code> as my default.
Therefore, you can create this config:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token builtin class-name">echo</span> uri_default <span class="token operator">=</span> <span class="token punctuation">\</span>"qemu:///system<span class="token punctuation">\</span>" <span class="token operator">>></span> ~/.config/libvirt/libvirt.conf</span></code></pre>

    </div><p>Now running <code class="language-plain">virsh net-list --all</code> is implicitly called like <code class="language-plain">virsh --connect qemu:///system net-list --all</code>,
which makes all commands on the CLI much easier to type.</p>
<h2 id="useful-virsh-cli-commands" tabindex="-1">5.6. Useful virsh CLI commands <a class="header-anchor" href="#useful-virsh-cli-commands" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Here is a full example how to set up an Ubuntu machine via libvirt and QEMU:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token comment"># Show all boxes (the libvirt term is 'domain' for whatever obscuring reason)</span></span>
<span class="highlight-line"><span class="token function">virsh</span> list <span class="token parameter variable">--all</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Show all networks</span></span>
<span class="highlight-line"><span class="token function">virsh</span> net-list <span class="token parameter variable">--all</span></span>
<span class="highlight-line"><span class="token comment"># Create a new network</span></span>
<span class="highlight-line"><span class="token function">virsh</span> net-define virsh-my-network.xml</span>
<span class="highlight-line"><span class="token function">virsh</span> net-start my-network</span>
<span class="highlight-line"><span class="token comment"># Show all clients in a network</span></span>
<span class="highlight-line"><span class="token function">virsh</span> net-dhcp-leases my-network</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Create a hard disk based on Ubuntu</span></span>
<span class="highlight-line"><span class="token function">sudo</span> <span class="token function">wget</span> --directory-prefix<span class="token operator">=</span>/var/lib/libvirt/images/ https://cloud-images.ubuntu.com/kinetic/current/kinetic-server-cloudimg-amd64.img</span>
<span class="highlight-line"><span class="token function">sudo</span> qemu-img create <span class="token parameter variable">-b</span> /var/lib/libvirt/images/kinetic-server-cloudimg-amd64.img <span class="token parameter variable">-f</span> qcow2 <span class="token parameter variable">-F</span> qcow2 /var/lib/libvirt/images/my-disk.qcow2 125G</span>
<span class="highlight-line">qemu-img info /var/lib/libvirt/images/my-disk.qcow2</span>
<span class="highlight-line"><span class="token function">sudo</span> <span class="token function">chown</span> libvirt-qemu:libvirt-qemu /var/lib/libvirt/images/my-disk.qcow2</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Create a cloud-init .iso file</span></span>
<span class="highlight-line"><span class="token function">sudo</span> cloud-localds /var/lib/libvirt/images/box.cloudinit.iso box.user-data box.meta-data</span>
<span class="highlight-line"><span class="token function">sudo</span> <span class="token function">chown</span> libvirt-qemu:libvirt-qemu /var/lib/libvirt/images/box.cloudinit.iso</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Create and boot a new box</span></span>
<span class="highlight-line">virt-install <span class="token parameter variable">--name</span> my-box.libvirt <span class="token parameter variable">--memory</span> <span class="token number">4096</span> <span class="token parameter variable">--disk</span> /var/lib/libvirt/images/my-disk.qcow2,device<span class="token operator">=</span>disk,bus<span class="token operator">=</span>virtio <span class="token parameter variable">--disk</span> /var/lib/libvirt/images/box.cloudinit.iso,device<span class="token operator">=</span>cdrom <span class="token parameter variable">--osinfo</span> ubuntu22.10 --virt-type kvm <span class="token parameter variable">--graphics</span> none <span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>my-network <span class="token parameter variable">--import</span> <span class="token parameter variable">--noautoconsole</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Show configuration</span></span>
<span class="highlight-line"><span class="token function">virsh</span> dumpxml my-box.libvirt</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># After the boot you can connect to the box</span></span>
<span class="highlight-line"><span class="token function">ssh</span> user@my-box.libvirt</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment"># Start and stop the box</span></span>
<span class="highlight-line"><span class="token function">virsh</span> start my-box.libvirt</span>
<span class="highlight-line"><span class="token function">virsh</span> <span class="token function">shutdown</span> my-box.libvirt</span></code></pre>

    </div><details markdown="1">
<summary>Files</summary>
<p>Example network file:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-xml"><code data-filename="virsh-my-network.xml" class="language-xml"><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network</span> <span class="token attr-name">connections</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>1<span class="token punctuation">'</span></span><span class="token punctuation">></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>my-network<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uuid</span><span class="token punctuation">></span></span>e60f1806-bf2b-4991-be55-03d51ee38b50<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uuid</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>forward</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>nat<span class="token punctuation">'</span></span><span class="token punctuation">></span></span></span>
<span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nat</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>1024<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>65535<span class="token punctuation">'</span></span><span class="token punctuation">/></span></span></span>
<span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nat</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>forward</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bridge</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virbr1<span class="token punctuation">'</span></span> <span class="token attr-name">stp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>on<span class="token punctuation">'</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span><span class="token punctuation">/></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>52:54:00:7d:15:a7<span class="token punctuation">'</span></span><span class="token punctuation">/></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>libvirt<span class="token punctuation">'</span></span> <span class="token attr-name">localOnly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>yes<span class="token punctuation">'</span></span><span class="token punctuation">/></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.122.1<span class="token punctuation">'</span></span> <span class="token attr-name">netmask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>255.255.255.0<span class="token punctuation">'</span></span><span class="token punctuation">></span></span></span>
<span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dhcp</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>range</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.122.2<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.122.254<span class="token punctuation">'</span></span><span class="token punctuation">/></span></span></span>
<span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dhcp</span><span class="token punctuation">></span></span></span>
<span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">></span></span></span>
<span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network</span><span class="token punctuation">></span></span></span></code></pre>

    </div><p>Example cloud-init files:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-yaml"><code data-filename="box.meta-data" class="language-yaml"><span class="highlight-line"><span class="token key atrule">instance-id</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>box</span>
<span class="highlight-line"><span class="token key atrule">local-hostname</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>box</span></code></pre>

    </div><div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-yaml"><code data-filename="box.user-data" class="language-yaml"><span class="highlight-line"><span class="token comment">#cloud-config</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token key atrule">hostname</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>box</span>
<span class="highlight-line"><span class="token key atrule">local-hostname</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>box</span>
<span class="highlight-line"><span class="token key atrule">fqdn</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>box.libvirt</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token key atrule">users</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> user</span>
<span class="highlight-line">    <span class="token key atrule">primary_group</span><span class="token punctuation">:</span> users</span>
<span class="highlight-line">    <span class="token key atrule">sudo</span><span class="token punctuation">:</span> ALL=(ALL) NOPASSWD<span class="token punctuation">:</span>ALL</span>
<span class="highlight-line">    <span class="token key atrule">shell</span><span class="token punctuation">:</span> /bin/zsh</span>
<span class="highlight-line">    <span class="token key atrule">ssh_authorized_keys</span><span class="token punctuation">:</span></span>
<span class="highlight-line">      <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>rsa AAAAB<span class="token punctuation">...</span>p0= hostuser@host</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token key atrule">chpasswd</span><span class="token punctuation">:</span> </span>
<span class="highlight-line">  <span class="token key atrule">expire</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token key atrule">write_files</span><span class="token punctuation">:</span></span>
<span class="highlight-line"><span class="token punctuation">-</span> <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="highlight-line">    net.ipv6.conf.all.disable_ipv6 = 1</span>
<span class="highlight-line">    net.ipv6.conf.default.disable_ipv6 = 1</span></span>
<span class="highlight-line">  <span class="token key atrule">owner</span><span class="token punctuation">:</span> root<span class="token punctuation">:</span>root</span>
<span class="highlight-line">  <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/sysctl.d/00<span class="token punctuation">-</span>ipv6.conf</span>
<span class="highlight-line">  <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0644'</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token key atrule">packages</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  <span class="token punctuation">-</span> zsh</span>
<span class="highlight-line"><span class="token key atrule">package_update</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="highlight-line"><span class="token key atrule">package_upgrade</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="highlight-line"><span class="token key atrule">package_reboot_if_required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span></code></pre>

    </div></details>
<h1 id="vagrant" tabindex="-1">6. vagrant <a class="header-anchor" href="#vagrant" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Now everything is set up, the box runs, we are done, right?
Well, yes.</p>
<p>But personally I like to use Vagrant on top of my virtualization provider.
It allows to commit the configuration to your repo.
And people can just call <code class="language-plain">vagrant up</code> to do the whole setup process,
there is no need to follow a (maybe longer) command list.
Additionally, people can choose their personal favorite provider between libvirt, VirtualBox and more
(as long as the base box is available for the provider).</p>
<p>Make sure to have the Vagrant and its required plugins installed on your machine:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">sudo</span> pacman <span class="token parameter variable">-S</span> vagrant</span>
<span class="highlight-line">vagrant plugin <span class="token function">install</span> vagrant-hostmanager</span>
<span class="highlight-line">vagrant plugin <span class="token function">install</span> vagrant-libvirt</span>
<span class="highlight-line">vagrant plugin list</span></code></pre>

    </div><p>Here is a sample Vagrantfile I use:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-ruby"><code data-filename="Vagrantfile" class="language-ruby"><span class="highlight-line"><span class="token comment"># -*- mode: ruby -*-</span></span>
<span class="highlight-line"><span class="token comment"># vi: set ft=ruby :</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">Vagrant<span class="token punctuation">.</span>configure<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"generic/ubuntu2210"</span></span></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_version <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"4.2.4"</span></span></span>
<span class="highlight-line"></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>hostmanager<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>hostmanager<span class="token punctuation">.</span>manage_host <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>hostmanager<span class="token punctuation">.</span>manage_guest <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>hostmanager<span class="token punctuation">.</span>ignore_private_ip <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>hostmanager<span class="token punctuation">.</span>include_offline <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>define <span class="token string-literal"><span class="token string">'my-environment'</span></span> <span class="token keyword">do</span> <span class="token operator">|</span>node<span class="token operator">|</span></span>
<span class="highlight-line">    node<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>hostname <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'my-vagrant-box'</span></span></span>
<span class="highlight-line">  <span class="token keyword">end</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token string-literal"><span class="token string">"shell"</span></span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span></span>
<span class="highlight-line">    ssh_pub_key <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token builtin">Dir</span><span class="token punctuation">.</span>home</span><span class="token delimiter punctuation">}</span></span><span class="token string">/.ssh/id_rsa.pub"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span>strip</span>
<span class="highlight-line">    s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string-literal heredoc-string"><span class="token delimiter"><span class="token punctuation">&lt;&lt;-</span><span class="token symbol">SHELL</span></span><span class="token string"></span>
<span class="highlight-line">      echo </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">ssh_pub_key</span><span class="token delimiter punctuation">}</span></span><span class="token string"> >> /home/vagrant/.ssh/authorized_keys</span>
<span class="highlight-line">    </span><span class="token delimiter"><span class="token symbol">SHELL</span></span></span></span>
<span class="highlight-line">  <span class="token keyword">end</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token string-literal"><span class="token string">"virtualbox"</span></span> <span class="token keyword">do</span> <span class="token operator">|</span>vb<span class="token operator">|</span></span>
<span class="highlight-line">    vb<span class="token punctuation">.</span>memory <span class="token operator">=</span> <span class="token number">4096</span></span>
<span class="highlight-line">    vb<span class="token punctuation">.</span>cpus <span class="token operator">=</span> <span class="token number">2</span></span>
<span class="highlight-line">  <span class="token keyword">end</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:libvirt</span> <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span></span>
<span class="highlight-line">    v<span class="token punctuation">.</span>memory <span class="token operator">=</span> <span class="token number">4096</span></span>
<span class="highlight-line">    v<span class="token punctuation">.</span>cpus <span class="token operator">=</span> <span class="token number">2</span></span>
<span class="highlight-line">  <span class="token keyword">end</span></span>
<span class="highlight-line"><span class="token keyword">end</span></span></code></pre>

    </div><p>Whether the user wants to use libvirt or VirtualBox, he can just put the file in a directory and call</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line">vagrant up</span></code></pre>

    </div><p>If necessary, he can explicitly pass the provider he would like to use via the <code class="language-plain">--provider=libvirt</code> flag.</p>
<h1 id="vagrant-and-windows" tabindex="-1">7. vagrant and Windows <a class="header-anchor" href="#vagrant-and-windows" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p><a href="https://github.com/andreas-mausch/whatsapp-viewer/blob/master/Vagrantfile" class="external-link" target="_blank">WhatsApp Viewer's Vagrantfile</a>
used a <a href="https://app.vagrantup.com/gusztavvargadr/boxes/windows-10" class="external-link" target="_blank">box</a> which is not available in libvirt's
format.</p>
<p>That's why I switched to a <a href="https://app.vagrantup.com/peru/boxes/windows-10-enterprise-x64-eval" class="external-link" target="_blank">different one</a>,
which supports both, libvirt and VirtualBox.</p>
<h2 id="winrm-problem%3A-openssl-md4" tabindex="-1">7.1. WinRM problem: OpenSSL MD4 <a class="header-anchor" href="#winrm-problem%3A-openssl-md4" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>However, when trying to set it up I got a cryptic error message:</p>
<blockquote>
<p>Shell: Cmd
Command: hostname
Message: Digest initialization failed: initialization error
INFO interface: Machine: error-exit [&quot;VagrantPlugins::CommunicatorWinRM::Errors::ExecutionError&quot;, &quot;An error occurred executing a remote WinRM command.\n\nShell: Cmd\nCommand: hostname\nMessage: Digest initialization failed: initialization error&quot;]</p>
</blockquote>
<p>I ran <code class="language-plain">vagrant up --debug</code>, which gave me this:</p>
<details markdown="1">
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">Shell: Cmd</span>
<span class="highlight-line">Command: hostname</span>
<span class="highlight-line">Message: Digest initialization failed: initialization error</span>
<span class="highlight-line">ERROR vagrant: /opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/shell.rb:198:in `raise_winrm_exception'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/shell.rb:140:in `rescue in execute_with_rescue'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/shell.rb:137:in `execute_with_rescue'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/shell.rb:71:in `block in cmd'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/winrm-2.3.6/lib/winrm/connection.rb:42:in `shell'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/shell.rb:70:in `cmd'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/communicator.rb:107:in `block in ready?'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:179:in `block in timeout'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:36:in `block in catch'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:36:in `catch'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:36:in `catch'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:188:in `timeout'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/communicator.rb:106:in `ready?'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/communicator.rb:57:in `block in wait_for_ready'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:179:in `block in timeout'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:36:in `block in catch'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:36:in `catch'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:36:in `catch'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/timeout-0.3.0/lib/timeout.rb:188:in `timeout'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/plugins/communicators/winrm/communicator.rb:31:in `wait_for_ready'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/vagrant-2.3.3/lib/vagrant/action/builtin/wait_for_communicator.rb:16:in `block in call'</span>
<span class="highlight-line">/opt/vagrant/embedded/gems/2.3.3/gems/logging-2.3.1/lib/logging/diagnostic_context.rb:474:in `block in create_with_logging_context'</span>
<span class="highlight-line"> INFO interface: error: An error occurred executing a remote WinRM command.</span></code></pre>

    </div></details>
<p>This was not very helpful.
I found a <a href="https://github.com/hashicorp/vagrant/issues/12807" class="external-link" target="_blank">GitHub issue</a> with a similar problem, but no solution.
Then I found <a href="https://dev.to/wetterkrank/openssldigestdigesterror-when-using-md4-3o0i" class="external-link" target="_blank">this blog post</a> which hinted to a problem
with an OpenSSL update.</p>
<p>However, I had no problem to connect to WinRM via curl <a href="https://nathanwebster.me/2017/ansible-windows-testing-winrm-connections/" class="external-link" target="_blank">manually</a>.</p>
<p>Finally I found <a href="https://stackoverflow.com/questions/69938570/md4-hashlib-support-in-python-3-8" class="external-link" target="_blank">the solution here</a>.</p>
<p>The problem was NTLM still uses MD4 hashes, and those are disabled in newer OpenSSL releases.</p>
<p>I had to edit the OpenSSL config file to re-enable MD4
(Oh man, how I love good error handling with descriptive messages..).</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code data-filename="/etc/ssl/openssl.cnf" class="language-plain"><span class="highlight-line">[provider_sect]</span>
<span class="highlight-line">default = default_sect</span>
<span class="highlight-line">legacy = legacy_sect</span>
<span class="highlight-line"></span>
<span class="highlight-line">[default_sect]</span>
<span class="highlight-line">activate = 1</span>
<span class="highlight-line"></span>
<span class="highlight-line">[legacy_sect]</span>
<span class="highlight-line">activate = 1</span></code></pre>

    </div><p>After that, even the ruby <a href="https://github.com/WinRb/WinRM#example" class="external-link" target="_blank">WinRM example</a> worked flawlessly.</p>
<h1 id="apple-silicon" tabindex="-1">8. Apple Silicon <a class="header-anchor" href="#apple-silicon" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<ul>
<li>✅ libvirt works on M1</li>
<li>✅ Vagrant 2.3.3 can be installed on M1
<ul>
<li>However, it ships it's own embedded version of ruby, instead of using the one provided by the system. 🤮</li>
<li>And, that shipped version is x86_64 always.</li>
<li>And, that version (2.7.0) is from December 2019.</li>
<li>And, Ruby offers a newer 2.x release: 2.7.7, from November 2022.</li>
<li>And, support for 2.7.x ends in three months: <a href="https://endoflife.date/ruby" class="external-link" target="_blank">2023-03-31</a>.</li>
<li>And, of course, there is the fully supported Ruby 3.x, which is out for almost two years now.</li>
</ul>
</li>
<li>🚧 However, the vagrant-libvirt plugin can not be installed ootb.</li>
</ul>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-shell-session"><code class="language-shell-session"><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">vagrant plugin <span class="token function">install</span> vagrant-libvirt</span></span></span>
<span class="highlight-line"><span class="token output">// ruby-libvirt-0.8.0.gem</span>
<span class="highlight-line">"gcc -o conftest -I/opt/vagrant/embedded/include/ruby-2.7.0/x86_64-darwin19 -I/opt/vagrant/embedded/include/ruby-2.7.0/ruby/backward -I/opt/vagrant/embedded/include/ruby-2.7.0 -I. -I/opt/homebrew/Cellar/libvirt/8.9.0/include -I/opt/vagrant/embedded/include -mmacosx-version-min=10.9 -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/opt/vagrant/embedded/include -D_XOPEN_SOURCE -D_DARWIN_C_SOURCE -D_DARWIN_UNLIMITED_SELECT -D_REENTRANT   -I/opt/vagrant/embedded/include -mmacosx-version-min=10.9 -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I./include -O3 -std=c99 -fno-common -pipe  conftest.c  -L. -L/opt/vagrant/embedded/lib -L/opt/vagrant/embedded/lib -L.  -mmacosx-version-min=10.9 -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -fstack-protector-strong -L/opt/vagrant/embedded/lib -L/opt/homebrew/Cellar/libvirt/8.9.0/lib     -lvirt -lruby.2.7 -lvirt  -lvirt  "</span>
<span class="highlight-line">conftest.c:16:13: error: conflicting types for 'virConnectOpen'</span>
<span class="highlight-line">extern void virConnectOpen();</span>
<span class="highlight-line">            ^</span>
<span class="highlight-line">/opt/homebrew/Cellar/libvirt/8.9.0/include/libvirt/libvirt-host.h:737:25: note: previous declaration is here</span>
<span class="highlight-line">virConnectPtr           virConnectOpen          (const char *name);</span>
<span class="highlight-line">                        ^</span>
<span class="highlight-line">conftest.c:17:30: error: too few arguments to function call, single argument 'name' was not specified</span>
<span class="highlight-line">int t(void) { virConnectOpen(); return 0; }</span>
<span class="highlight-line">              ~~~~~~~~~~~~~~ ^</span>
<span class="highlight-line">/opt/homebrew/Cellar/libvirt/8.9.0/include/libvirt/libvirt-host.h:737:25: note: 'virConnectOpen' declared here</span>
<span class="highlight-line">virConnectPtr           virConnectOpen          (const char *name);</span>
<span class="highlight-line">                        ^</span>
<span class="highlight-line">2 errors generated.</span></code></pre>

    </div><p>There is an <a href="https://github.com/vagrant-libvirt/vagrant-libvirt/issues/1205#issuecomment-1083794064" class="external-link" target="_blank">open issue on GitHub</a>
for exactly this plugin.</p>
<p>However, it is open since Februar 2021 already.
Two fixes are already merged in <a href="https://github.com/fog/fog-libvirt/pull/102" class="external-link" target="_blank">fog-libvirt</a>
and <a href="https://gitlab.com/libvirt/libvirt-ruby/-/merge_requests/19" class="external-link" target="_blank">libvirt-ruby</a>.</p>
<p>But both projects did not have a release for over a year now, and one of them is even an offical libvirt project.
This makes me think..</p>
<p>So I guess for Apple Silicon I still have to wait some time until Vagrant is fully supported.</p>
<h1 id="libvirt-vs.-virtualbox" tabindex="-1">9. libvirt vs. VirtualBox <a class="header-anchor" href="#libvirt-vs.-virtualbox" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Short summary: libvirt in general looks promising as an alternative to VirtualBox
and I will experiment more with it in the next months.</p>
<ul>
<li>👍 Runs all boxes on all system architectures</li>
<li>👍 Free software
(unlike VirtualBox' extension pack: Free for Personal Use only)</li>
<li>👍 Both work with Vagrant</li>
<li>👎 Steeper learning curve</li>
<li>👎 No similar concept (like .ova) to export a whole box</li>
<li>👎 Not much activity in an offical repo <a href="https://gitlab.com/libvirt/libvirt-ruby" class="external-link" target="_blank">libvirt-ruby</a></li>
</ul>


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
