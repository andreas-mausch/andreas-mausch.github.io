
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitMQ CLI, Dead Letter Exchange and Quorum Queue</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    <link rel="stylesheet" href="/styles/icons/iconism.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>RabbitMQ CLI, Dead Letter Exchange and Quorum Queue</h1>
<div>
  <time class="postlist-date" datetime="2022-02-24T22:00:00.000+00:00">Feb 24, 2022</time>
  <ul class="tags">
    
        
          <li><a href="/blog/tags/cli">#cli</a></li>
        
    
        
          <li><a href="/blog/tags/devops">#devops</a></li>
        
    
        
    
        
          <li><a href="/blog/tags/rabbitmq">#rabbitmq</a></li>
        
    
  </ul>
</div>



<p>Today I've taken a closer look at this code snippet in one of our services:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-java"><code class="language-java"><span class="highlight-line"><span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span><span class="token string">"${app.messaging.queueName}"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span></span>
<span class="highlight-line">                    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token string">"x-redelivered-count"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> count<span class="token punctuation">,</span></span>
<span class="highlight-line">                    <span class="token class-name">RabbitAcknowledgement</span> rabbitAcknowledgement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received message from queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        someService<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        rabbitAcknowledgement<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Couldn't send queued message to service"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> count <span class="token operator">>=</span> <span class="token constant">MAX_REDELIVER_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">            <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Max redeliver count limit of {} reached. Message will be discarded."</span><span class="token punctuation">,</span> <span class="token constant">MAX_REDELIVER_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">            <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Requeue message because of exception from service."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">            count <span class="token operator">=</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">++</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">            rabbitClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span></span>
<span class="highlight-line">        rabbitAcknowledgement<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>

    </div><p>So this piece makes sure if a message cannot be handled, it should be retried by re-queuing the same message,
but only for a maximum of <code class="language-plain">MAX_REDELIVER_COUNT</code> times.</p>
<p>I thought RabbitMQ should be able to handle this logic for us.
And indeed, it offers a retry mechanism.
It just needs to be enabled/used.</p>
<p>In this post, I walk you through the settings and CLI commands for a retry queue.
Also, we will have a dead letter queue, which catches all messages failing for more than <code class="language-plain">MAX_REDELIVER_COUNT</code> times.</p>
<h1 id="simple-topic-exchange-with-classic-queue" tabindex="-1">1. Simple topic exchange with classic queue <a class="header-anchor" href="#simple-topic-exchange-with-classic-queue" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span> rabbitmq <span class="token parameter variable">--rm</span> <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 rabbitmq:3.8-management</span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> exchange <span class="token assign-left variable">name</span><span class="token operator">=</span>my-exchange <span class="token assign-left variable">type</span><span class="token operator">=</span>topic <span class="token assign-left variable">durable</span><span class="token operator">=</span>true</span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> queue <span class="token assign-left variable">name</span><span class="token operator">=</span>my-queue <span class="token assign-left variable">durable</span><span class="token operator">=</span>true</span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> binding <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token string">"my-exchange"</span> <span class="token assign-left variable">destination_type</span><span class="token operator">=</span><span class="token string">"queue"</span> <span class="token assign-left variable">destination</span><span class="token operator">=</span><span class="token string">"my-queue"</span> <span class="token assign-left variable">routing_key</span><span class="token operator">=</span><span class="token string">"*"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin publish <span class="token assign-left variable">exchange</span><span class="token operator">=</span>my-exchange <span class="token assign-left variable">routing_key</span><span class="token operator">=</span>my-routing-key <span class="token assign-left variable">properties</span><span class="token operator">=</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>delivery_mode<span class="token entity" title="\&quot;">\"</span>:2}"</span> <span class="token assign-left variable">payload</span><span class="token operator">=</span><span class="token string">'test'</span></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin get <span class="token assign-left variable">queue</span><span class="token operator">=</span>my-queue <span class="token assign-left variable">ackmode</span><span class="token operator">=</span>ack_requeue_true <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">4</span></span></code></pre>

    </div><h1 id="add-a-dead-letter-queue" tabindex="-1">2. Add a dead letter queue <a class="header-anchor" href="#add-a-dead-letter-queue" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Use the same <code class="language-plain">my-exchange</code> as above.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> exchange <span class="token assign-left variable">name</span><span class="token operator">=</span>dead-letter-exchange <span class="token assign-left variable">type</span><span class="token operator">=</span>topic <span class="token assign-left variable">durable</span><span class="token operator">=</span>true</span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> queue <span class="token assign-left variable">name</span><span class="token operator">=</span>dead-letter-queue <span class="token assign-left variable">durable</span><span class="token operator">=</span>true</span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> binding <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token string">"dead-letter-exchange"</span> <span class="token assign-left variable">destination_type</span><span class="token operator">=</span><span class="token string">"queue"</span> <span class="token assign-left variable">destination</span><span class="token operator">=</span><span class="token string">"dead-letter-queue"</span> <span class="token assign-left variable">routing_key</span><span class="token operator">=</span><span class="token string">"*"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> queue <span class="token assign-left variable">name</span><span class="token operator">=</span>my-dlx-queue <span class="token assign-left variable">durable</span><span class="token operator">=</span>true <span class="token assign-left variable">arguments</span><span class="token operator">=</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>x-dead-letter-exchange<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>dead-letter-exchange<span class="token entity" title="\&quot;">\"</span>}"</span></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> binding <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token string">"my-exchange"</span> <span class="token assign-left variable">destination_type</span><span class="token operator">=</span><span class="token string">"queue"</span> <span class="token assign-left variable">destination</span><span class="token operator">=</span><span class="token string">"my-dlx-queue"</span> <span class="token assign-left variable">routing_key</span><span class="token operator">=</span><span class="token string">"*"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin publish <span class="token assign-left variable">exchange</span><span class="token operator">=</span>my-exchange <span class="token assign-left variable">routing_key</span><span class="token operator">=</span>my-routing-key <span class="token assign-left variable">properties</span><span class="token operator">=</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>delivery_mode<span class="token entity" title="\&quot;">\"</span>:2}"</span> <span class="token assign-left variable">payload</span><span class="token operator">=</span><span class="token string">'test'</span></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin get <span class="token assign-left variable">queue</span><span class="token operator">=</span>my-dlx-queue <span class="token assign-left variable">ackmode</span><span class="token operator">=</span>reject_requeue_false <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">4</span></span></code></pre>

    </div><p>Note: We set the <code class="language-plain">ackmode</code> to <code class="language-plain">reject_requeue_false</code> to reject the message.
The rejected message will be placed in the <code class="language-plain">dead-letter-queue</code>.</p>
<h1 id="use-a-quorum-queue-for-automatic-retries" tabindex="-1">3. Use a quorum queue for automatic retries <a class="header-anchor" href="#use-a-quorum-queue-for-automatic-retries" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>RabbitMQ offers a special queue type which has a retry feature: <a href="https://www.rabbitmq.com/quorum-queues.html" class="external-link" target="_blank">Quorum queues</a>.
The feature is named <em>Poison Message Handling</em> and can be enabled by setting <code class="language-plain">x-delivery-limit</code> on the queue.</p>
<blockquote>
<p>Quorum queues typically require more resources (disk and RAM) than classic mirrored queues.</p>
</blockquote>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> queue <span class="token assign-left variable">name</span><span class="token operator">=</span>my-quorum-queue <span class="token assign-left variable">queue_type</span><span class="token operator">=</span>quorum <span class="token assign-left variable">durable</span><span class="token operator">=</span>true <span class="token assign-left variable">arguments</span><span class="token operator">=</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>x-dead-letter-exchange<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>dead-letter-exchange<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>x-dead-letter-routing-key<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>bar<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>x-delivery-limit<span class="token entity" title="\&quot;">\"</span>:3}"</span></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin <span class="token builtin class-name">declare</span> binding <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token string">"my-exchange"</span> <span class="token assign-left variable">destination_type</span><span class="token operator">=</span><span class="token string">"queue"</span> <span class="token assign-left variable">destination</span><span class="token operator">=</span><span class="token string">"my-quorum-queue"</span> <span class="token assign-left variable">routing_key</span><span class="token operator">=</span><span class="token string">"*"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin publish <span class="token assign-left variable">exchange</span><span class="token operator">=</span>my-exchange <span class="token assign-left variable">routing_key</span><span class="token operator">=</span>my-routing-key <span class="token assign-left variable">properties</span><span class="token operator">=</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>delivery_mode<span class="token entity" title="\&quot;">\"</span>:2}"</span> <span class="token assign-left variable">payload</span><span class="token operator">=</span><span class="token string">'test'</span></span>
<span class="highlight-line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq rabbitmqadmin get <span class="token assign-left variable">queue</span><span class="token operator">=</span>my-quorum-queue <span class="token assign-left variable">ackmode</span><span class="token operator">=</span>ack_requeue_true <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">4</span></span></code></pre>

    </div><p>Note: We set <code class="language-plain">x-dead-letter-routing-key</code> this time. This is optional, just to show it is possible.
And of course we set the <code class="language-plain">queue_type</code>. This is a <a href="https://github.com/rabbitmq/rabbitmq-management/issues/761" class="external-link" target="_blank">CLI shortcut</a>
for having an argument <code class="language-plain">x-queue-type</code> set to <code class="language-plain">quorum</code>.</p>
<p>If we run <code class="language-plain">rabbitmqadmin get</code>, we see it has a new header field <code class="language-plain">x-delivery-count</code> set to 0.</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-plain"><code class="language-plain"><span class="highlight-line">+----------------+-------------+---------------+---------+---------------+------------------+--------------------------+-------------------------------------+-------------+</span>
<span class="highlight-line">|  routing_key   |  exchange   | message_count | payload | payload_bytes | payload_encoding | properties.delivery_mode | properties.headers.x-delivery-count | redelivered |</span>
<span class="highlight-line">+----------------+-------------+---------------+---------+---------------+------------------+--------------------------+-------------------------------------+-------------+</span>
<span class="highlight-line">| my-routing-key | my-exchange | 0             | test    | 4             | string           | 2                        | 0                                   | False       |</span>
<span class="highlight-line">+----------------+-------------+---------------+---------+---------------+------------------+--------------------------+-------------------------------------+-------------+</span></code></pre>

    </div><p>We can run the command for three more times, always receiving the same message.
On the fifth time we don't receive any more messages.</p>
<p>If we look into the <code class="language-plain">dead-letter-queue</code>, we find it has moved here, which is exactly what we tried to accomplish:
Retry for three times, then move into DLX.</p>
<h1 id="simplified-consumer" tabindex="-1">4. Simplified consumer <a class="header-anchor" href="#simplified-consumer" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Now back to our Java code, the consumer now looks much simpler:</p>
<div class="code-block">
    <button type="button" class="copy-to-clipboard">
      <i class="icon icon-copy"></i>
    </button>
    <pre class="language-java"><code class="language-java"><span class="highlight-line"><span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"${app.messaging.queueName}"</span><span class="token punctuation">,</span> reQueue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span></span>
<span class="highlight-line">                    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token string">"x-delivery-count"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> deliveryCount<span class="token punctuation">,</span></span>
<span class="highlight-line">                    <span class="token class-name">Envelope</span> envelope<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received message from queue. Routing key: {}; Redelivered: {}, Delivery count: {}"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            envelope<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> envelope<span class="token punctuation">.</span><span class="token function">isRedeliver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deliveryCount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    someService<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>

    </div><p>Differences:</p>
<ul>
<li>Our self-invented <code class="language-plain">x-redelivered-count</code> is replaced by RabbitMQ's <code class="language-plain">x-delivery-count</code>.</li>
<li>We set <code class="language-plain">reQueue = true</code> to automatically re-queue messages on exceptions.</li>
<li>The acknolegment (<code class="language-plain">RabbitAcknowledgement</code>) is now done by <a href="https://micronaut-projects.github.io/micronaut-rabbitmq/3.1.0/guide/index.html#consumerAcknowledge" class="external-link" target="_blank">our framework</a> (Micronaut).</li>
<li>The whole exception handling block is gone. Yay.</li>
</ul>
<h1 id="possible-values-for-ackmode" tabindex="-1">5. Possible values for ackmode <a class="header-anchor" href="#possible-values-for-ackmode" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>See <a href="https://github.com/rabbitmq/rabbitmq-server/blob/e36a50a75c12d5aa8d2c7206c49cabfe4116fa72/deps/rabbitmq_management/src/rabbit_mgmt_wm_queue_get.erl#L90" class="external-link" target="_blank">here</a>
and <a href="https://github.com/rabbitmq/rabbitmq-server/blob/e36a50a75c12d5aa8d2c7206c49cabfe4116fa72/deps/rabbitmq_management/priv/www/js/tmpl/queue.ejs#L318" class="external-link" target="_blank">here</a>.</p>
<table>
<thead>
<tr>
<th>ackmode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ack_requeue_true</td>
<td>Nack message requeue true</td>
</tr>
<tr>
<td>ack_requeue_false</td>
<td>Automatic ack</td>
</tr>
<tr>
<td>reject_requeue_true</td>
<td>Reject requeue true</td>
</tr>
<tr>
<td>reject_requeue_false</td>
<td>Reject requeue false</td>
</tr>
</tbody>
</table>
<h1 id="documentation%3F" tabindex="-1">6. Documentation? <a class="header-anchor" href="#documentation%3F" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I find the documentation about <code class="language-plain">rabbitmqadmin</code> very poor.
I had to look up the possible values for <code class="language-plain">ackmode</code> in the sources, the option to display message headers (<code class="language-plain">--depth</code>) is just not very intuitive, and
the <code class="language-plain">delivery_mode</code> 2 for persistent messages is..also not very intuitive. The last one might be the fault of AMQP, but nevertheless the documentation about
it is bad (just mentioned in the <a href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html" class="external-link" target="_blank">tutorial</a>).</p>
<p>Also, how does <code class="language-plain">ack_requeue_true</code> map to <em>Nack message requeue true</em>? Well.</p>
<h1 id="delay%3F" tabindex="-1">7. Delay? <a class="header-anchor" href="#delay%3F" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I wish there would also be an option to have a delay between retries.
If a service is not available, it might be because of a short downtime and it might be up again in five minutes.</p>
<p>I know about the <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange" class="external-link" target="_blank">rabbitmq-delayed-message-exchange</a>.
However, if we set <code class="language-plain">x-delay</code> on the initial message, the first delivery won't be instantly.
I don't know about an easy way to have a message handled instantly for the first time, but having an
(in best case increasing) delay for subsequent retries.</p>
<p>If this is needed, I might start with the Java snippet from above and manually requeue the message with a programmatically set <code class="language-plain">x-delay</code> header.
Another option I haven't tried is using a dead-letter-queue
<a href="https://dev.to/realflowcontrol/delayed-requeuing-with-rabbitmq-kc7" class="external-link" target="_blank">combined</a>
<a href="https://dzone.com/articles/rabbitmq-consumer-retry-mechanism" class="external-link" target="_blank">with a</a>
<a href="https://jack-vanlightly.com/blog/2017/3/24/rabbitmq-delayed-retry-approaches-that-work" class="external-link" target="_blank">time-to-live (TTL)</a>,
but to me that seems like abusing the dead-letter concept a bit and you end up with a lot of queues and exchanges. Simplicity? Gone.</p>
<p>It's a shame this feature is not supported out-of-the-box, because I think it's a pretty common use case.</p>


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
