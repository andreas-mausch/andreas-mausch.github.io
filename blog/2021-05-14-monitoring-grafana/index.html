
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring: Grafana, Loki, Prometheus, Alertmanager</title>
    <link rel="stylesheet" href="/styles/style.css"/>
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-header-content">
        <a class="site-title" href="/">Andreas Mausch</a>
        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              version="1.1"
              viewbox="0 0 16 16"
              width="100%"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5">
              <path d="m2.75 12.25h10.5m-10.5-4h10.5m-10.5-4h10.5"/>
            </svg>
          </a>
          <input id="nav-toggle" type="checkbox"/>
          <label class="nav-button-container" for="nav-toggle">
            <div class="nav-button"></div>
          </label>
          <ol class="site-nav-items">
            <a class="page-link" href="/"><li class="page-link-home">Home</li></a><a class="page-link" href="/whatsapp-viewer/"><li>WhatsApp Viewer</li></a><a class="page-link" href="/blog/"><li>Blog</li></a></ol>
        </nav>
      </div>
    </header>
    <div class="content">
      
<h1>Blog post: Monitoring: Grafana, Loki, Prometheus, Alertmanager</h1>
<div>
  <time class="postlist-date" datetime="2021-05-14T12:00:00.000+00:00">May 14, 2021</time>
</div>



<p>Most of the times I evaluate tools or libraries I get disappointed:
Bugs in the most common features, missing the simplest of use-cases, bad documentation, etc.</p>
<p>So that's why I've decided to write a praise to Grafana and Loki,
which I've both heavily enjoyed to set up and use.</p>
<p>See my repo with a fully running setup here: <a href="https://github.com/andreas-mausch/grafana-prometheus-loki-alertmanager-setup" class="external-link" target="_blank">andreas-mausch/grafana-prometheus-loki-alertmanager-setup</a></p>
<img src="/blog/2021-05-14-monitoring-grafana/grafana.png" width="1511" height="976" alt="undefined">
<img src="/blog/2021-05-14-monitoring-grafana/prometheus.png" width="1511" height="976" alt="undefined">
<img src="/blog/2021-05-14-monitoring-grafana/mailhog.png" width="1511" height="976" alt="undefined">
<h1 id="background" tabindex="-1">1. Background <a class="header-anchor" href="#background" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I've used the ELK stack at AWS before (Elasticsearch, Logstash, Kibana), and maybe my setup
contained errors, but the user experience in general was awful for me.
Searches took long time (&gt;20sec), I didn't like the filtering much and from time to time
the server crashed on pretty much basic queries.</p>
<p>Now in my current project I was looking for alternatives.
I knew Grafana from a previous project, but never set it up myself
(we had a dedicated Ops team there).</p>
<p>So this was now my first time to set up Grafana myself.
I will not go into too much details, you will find an excellent documentation at Grafana Labs.
Instead, I will just write down steps I've handled differently.</p>
<p>Spoiler: I ended up with a solution where I can search the logs from all our services full-text
within &lt;3seconds and I have alerting on logs which contain words like 'error' or 'exception'.</p>
<h1 id="prometheus%2C-alertmanager" tabindex="-1">2. Prometheus, Alertmanager <a class="header-anchor" href="#prometheus%2C-alertmanager" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Both of them were already set up before.
We use <a href="https://prometheus.io/docs/guides/cadvisor/" class="external-link" target="_blank">cadvisor</a> to get notified whenever a
docker service has problems.
One thing I'm really missing here is the healthcheck (see <a href="https://github.com/google/cadvisor/issues/2166" class="external-link" target="_blank">the issue here</a>),
but beside that it works well.</p>
<h1 id="loki%2C-docker-driver" tabindex="-1">3. Loki, Docker Driver <a class="header-anchor" href="#loki%2C-docker-driver" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Loki runs as a simple docker container and the <a href="https://grafana.com/docs/loki/latest/clients/docker-driver/" class="external-link" target="_blank">docker plugin</a>
sends the logs from the containers to the loki server.</p>
<p>The alternative to the docker driver would be <a href="https://grafana.com/docs/loki/latest/clients/promtail/" class="external-link" target="_blank">Promtail</a>, which reads log files
from a specified directory and forwards them to Loki.</p>
<h2 id="configuration" tabindex="-1">3.1. Configuration <a class="header-anchor" href="#configuration" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>For docker swarm users: Unfortunately, there is no setting to configure the log-opts per docker stack, only per service.
So you need to either set them globally, or duplicate them at each container.</p>
<p>The changes I made to the default config file (<em>/etc/loki/config.yaml</em>) was the connection to the alertmanager
and the persistence settings (see below).
Also, I've added a <em>/etc/loki/rules/alerts/rules.yml</em> for the alerting.</p>
<h2 id="permission" tabindex="-1">3.2. Permission <a class="header-anchor" href="#permission" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<pre class="language-plain"><code class="language-plain"><span class="highlight-line">loki_1     | level=error ts=2021-05-14T16:19:26.017663788Z caller=log.go:106 msg="error initializing bucket client" err="mkdir /data/loki/chunks: permission denied"</span></code></pre>
<p>I can find <a href="https://github.com/grafana/loki/issues/1833" class="external-link" target="_blank">two</a> <a href="https://github.com/grafana/loki/issues/2018" class="external-link" target="_blank">issues</a>
for this error, but they have been closed already. I still have this problem though.</p>
<p>My (ugly) workaround: Let run loki as root.</p>
<h1 id="grafana" tabindex="-1">4. Grafana <a class="header-anchor" href="#grafana" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>Grafana has two data sources: Prometheus and Loki.<br>
You can search for log entries and also see all Prometheus metrics in Grafana. Nice.</p>
<h2 id="authentication" tabindex="-1">4.1. Authentication <a class="header-anchor" href="#authentication" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>We use a Keycloak server for user authentication, and it was easily possible to connect Grafana to it via their OAuth settings.</p>
<p>One note here: You configure four URLs in Grafana: <em>auth_url</em>, <em>token_url</em>, <em>api_url</em> and <em>signout_redirect_url</em>.
Our Grafana container has no access to the internet, and therefore we couldn't use the public keycloak URL in all cases.
That would have required some proxy configuration at least.</p>
<p>But there is a difference in the URLs: Some of them are called by the user's browser, and some of them are called by the Grafana container!</p>
<p>So only <em>auth_url</em> and <em>signout_redirect_url</em> are called by the user, and they need to be publicly available URLs.
<em>token_url</em> and <em>api_url</em> can be set to URLs only accessible in the local network (they should lead to the same Keycloak server though).</p>
<h3 id="user-exists-in-keycloak%2C-but-has-no-grafana-role" tabindex="-1">4.1.1. User exists in Keycloak, but has no grafana role <a class="header-anchor" href="#user-exists-in-keycloak%2C-but-has-no-grafana-role" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>Currently, Grafana cannot deny access to an authenticated user.<br>
He will at least get the <em>Viewer</em> role.</p>
<p>But in the latest unreleased version there is a fix already: <code class="language-plain">role_attribute_strict</code>.<br>
See <a href="https://github.com/grafana/grafana/pull/28021" class="external-link" target="_blank">here</a> and <a href="https://github.com/grafana/grafana/issues/23218" class="external-link" target="_blank">here</a>.</p>
<p>I will be available in version 8.0.0.</p>
<h3 id="my-auth-settings-for-grafana" tabindex="-1">4.1.2. My auth settings for Grafana <a class="header-anchor" href="#my-auth-settings-for-grafana" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<pre class="language-plain"><code class="language-plain"><span class="highlight-line">[auth]</span>
<span class="highlight-line">disable_login_form = true</span>
<span class="highlight-line">oauth_auto_login = true</span>
<span class="highlight-line">signout_redirect_url = https://keycloak.mycompany.com/auth/realms/my-realm/protocol/openid-connect/logout</span>
<span class="highlight-line"></span>
<span class="highlight-line">[auth.anonymous]</span>
<span class="highlight-line">enabled = false</span>
<span class="highlight-line"></span>
<span class="highlight-line">[auth.generic_oauth]</span>
<span class="highlight-line">name = Keycloak</span>
<span class="highlight-line">enabled = true</span>
<span class="highlight-line">client_id = grafana</span>
<span class="highlight-line">client_secret = </span>
<span class="highlight-line">scopes = openid profile email</span>
<span class="highlight-line">email_attribute_name = email:primary</span>
<span class="highlight-line">role_attribute_path = "roles[*] &amp;&amp; contains(roles[*], 'admin') &amp;&amp; 'Admin' || roles[*] &amp;&amp; contains(roles[*], 'editor') &amp;&amp; 'Editor' || roles[*] &amp;&amp; contains(roles[*], 'viewer') &amp;&amp; 'Viewer' || 'Forbidden'"</span>
<span class="highlight-line">role_attribute_strict = true</span>
<span class="highlight-line">auth_url = https://keycloak.mycompany.com/auth/realms/my-realm/protocol/openid-connect/auth</span>
<span class="highlight-line">token_url = http://keycloak.intranet/auth/realms/my-realm/protocol/openid-connect/token</span>
<span class="highlight-line">api_url = http://keycloak.intranet/auth/realms/my-realm/protocol/openid-connect/userinfo</span>
<span class="highlight-line"></span>
<span class="highlight-line"># Logging for debugging OAuth Token</span>
<span class="highlight-line">[log]</span>
<span class="highlight-line">filters = oauth:debug oauth.generic_oauth:debug</span></code></pre>
<p>Use the debug log to analyze errors, display the token etc.</p>
<p>These two links were helpful:</p>
<ul>
<li><a href="https://www.lars-fischer.me/posts/2021/grafana-sso-integration-with-keycloak/" class="external-link" target="_blank">https://www.lars-fischer.me/posts/2021/grafana-sso-integration-with-keycloak/</a></li>
<li><a href="https://janikvonrotz.ch/2020/08/27/grafana-oauth-with-keycloak-and-how-to-validate-a-jwt-token/" class="external-link" target="_blank">https://janikvonrotz.ch/2020/08/27/grafana-oauth-with-keycloak-and-how-to-validate-a-jwt-token/</a></li>
</ul>
<h1 id="multiline" tabindex="-1">5. Multiline <a class="header-anchor" href="#multiline" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>One feature which is pretty essential in my opinion and is only available
since <a href="https://grafana.com/blog/2021/03/11/grafana-loki-2.2-released-multi-line-logs-crash-resiliency-and-performance-improvements/" class="external-link" target="_blank">March 2021</a>: multiline stages.</p>
<p>Your Java application might produce a single (multi-line) log event for an Exception,
but the docker logs handle them just as separate single lines.
So Loki cannot easily decide which blocks of lines belong together.
That's why you can set up the multiline stage and tell Loki a regex pattern which your log entries start with,
for example a timestamp.
Loki will then group these lines again and Grafana can display them together.</p>
<div class="image-comparison-slider"><img-comparison-slider><img slot="first" src="/blog/2021-05-14-monitoring-grafana/before-multiline.png" width="640" height="240" style="max-height: 80vh" /><img slot="second" src="/blog/2021-05-14-monitoring-grafana/after-multiline.png"  width="640" height="240" style="max-height: 80vh" /><svg slot="handle" class="image-comparison-slider-handle" xmlns="http://www.w3.org/2000/svg" width="125" viewBox="-8 -3 16 6"><path stroke="#777" d="M -5 -2 L -7 0 L -5 2 M -5 -2 L -5 2 M 5 -2 L 7 0 L 5 2 M 5 -2 L 5 2" stroke-width="1" fill="currentColor" vector-effect="non-scaling-stroke"></path></svg></img-comparison-slider></div>
<h1 id="colors" tabindex="-1">6. Colors <a class="header-anchor" href="#colors" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>A special note here: If you use colored output for your log files, you need to include the hex codes in the regex.</p>
<p>I've used this <em>'^\d{2}:\d{2}:\d{2},\d{3}'</em> regex and was surprised it didn't match the following line:
<code class="language-plain">13:37:00,123 Test output</code></p>
<p>That's because I had colored logs configured with logback:</p>
<pre class="language-plain"><code class="language-plain"><span class="highlight-line">%cyan(%d{HH:mm:ss.SSS}) %gray([%thread]) %highlight(%-5level) %magenta(%logger{36}) - %msg%n</span></code></pre>
<p>This leads to the first character not being a <em>1</em>, but the hex value 0x1B (or <em>\033</em> octal):
The <a href="https://en.wikipedia.org/wiki/Escape_character#ASCII_escape_character" class="external-link" target="_blank">ASCII Escape character</a></p>
<img src="/blog/2021-05-14-monitoring-grafana/hello-world-colored.png" width="555" height="86" alt="undefined">
<p>So in order to filter by the colored output, I've used this regex:</p>
<pre class="language-plain"><code class="language-plain"><span class="highlight-line">^\x1B\[36m\d{2}:\d{2}:\d{2},\d{3}</span></code></pre>
<h1 id="persistence" tabindex="-1">7. Persistence <a class="header-anchor" href="#persistence" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>When playing around with loki and restarting the service a couple of times,
I've noticed I lost log entries.</p>
<h2 id="ingester%2C-write-ahead-log" tabindex="-1">7.1. Ingester, Write-Ahead Log <a class="header-anchor" href="#ingester%2C-write-ahead-log" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>Some investigation, and I found that the <em>ingester</em> only persists logs every few minutes.
This can be configured, at <em>chunk_idle_period</em> for <a href="https://grafana.com/docs/loki/latest/configuration/#ingester_config" class="external-link" target="_blank">example</a>.</p>
<p>Now, there is a good blog post at Grafana Labs where they explain how to not lose data.
It's pretty recent (Feb 2021), because the feature is just available.<br>
Here: <a href="https://grafana.com/blog/2021/02/16/the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki/" class="external-link" target="_blank">https://grafana.com/blog/2021/02/16/the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki/</a></p>
<p>I'm still wondering how these can not be the defaults settings though. :(<br>
I'm also wondering how the WAL config is not mentioned anywhere on their
<a href="https://grafana.com/docs/loki/latest/configuration/examples/" class="external-link" target="_blank">example config page</a>.</p>
<p>So please enable the Write-Ahead Log (WAL) and make sure the directory is persisted, for example in a docker volume.
Check <a href="https://github.com/andreas-mausch/grafana-prometheus-loki-alertmanager-setup/blob/master/loki/loki.yml" class="external-link" target="_blank">my loki config</a> for an example.</p>
<p>I've ran into this error, which could be easily fixed by doing what the error message suggests:</p>
<pre class="language-plain"><code class="language-plain"><span class="highlight-line">invalid ingester config: the use of the write ahead log (WAL) is incompatible with chunk transfers. It's suggested to use the WAL. Please try setting ingester.max-transfer-retries to 0 to disable transfers</span></code></pre>
<p>Strange: <a href="https://grafana.com/docs/loki/latest/operations/storage/wal/" class="external-link" target="_blank">The docu</a> talks about a <code class="language-plain">--ingester.recover-from-wal</code> setting.</p>
<blockquote>
<p><code class="language-plain">--ingester.recover-from-wal</code> to true to recover data from an existing WAL. The data is recovered even if WAL is disabled and this is set to true. The WAL dir needs to be set for this. If you are going to enable WAL, it is advisable to always set this to true.</p>
</blockquote>
<p>I couldn't find it anywhere (even browsed the sources), so I did not use it.</p>
<h2 id="retention" tabindex="-1">7.2. Retention <a class="header-anchor" href="#retention" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>And last, I've set the loki <em>retention_period</em> to 14 days to get rid of old logs and keep the disk usage low.</p>
<p>Note: There are two retention times.
One for loki, and one for Prometheus.
Prometheus setting is named <em>storage.tsdb.retention.time</em> and defaults to 15 days.
I haven't changed the value.</p>
<h1 id="memory-usage" tabindex="-1">8. Memory usage <a class="header-anchor" href="#memory-usage" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h1>
<p>I've updated the grafana dashboard to also display the memory usage per docker compose service.
Data comes from cadvisor.</p>
<p>The Prometheus query is this:</p>
<pre class="language-plain"><code class="language-plain"><span class="highlight-line">sum by (container_label_com_docker_compose_service) (container_memory_usage_bytes{container_label_com_docker_compose_service=~".+"})</span></code></pre>
<p>In case you use docker swarm, you can use <em>container_label_com_docker_swarm_service_name</em> instead of <em>container_label_com_docker_compose_service</em>.</p>
<img src="/blog/2021-05-14-monitoring-grafana/grafana-with-memory-usage.png" width="1550" height="885" alt="undefined">


<script async src="/scripts/index.js"></script>

    </div>
  </body>
</html>
